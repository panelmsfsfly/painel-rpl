<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RPL Dispatch 7.1</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b111e; --card:#151e2d; --input:#0f1724;
      --text:#f1f5f9; --muted:#94a3b8; --border:#233147;
      --pri:#3b82f6; --cy:#06b6d4; --gr:#10b981; --or:#f59e0b; --pu:#8b5cf6; --rd:#ef4444;
      --r:10px; --shadow:0 8px 20px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui; }
    .shell{max-width:1400px;margin:0 auto;padding:18px;display:flex;flex-direction:column;gap:14px}

    /* Header */
    .topbar{
      background:linear-gradient(180deg, rgba(21,30,45,.92), rgba(21,30,45,.78));
      border:1px solid var(--border); border-radius:var(--r); box-shadow:var(--shadow);
      padding:16px 18px; display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand h1{margin:0;font-size:20px;font-weight:900;letter-spacing:-.4px}
    .brand h1 span{color:var(--pri)}
    .brand .sub{margin-top:4px;font-size:11px;font-weight:800;color:var(--cy);letter-spacing:1px;text-transform:uppercase}
    .center{display:flex;flex-direction:column;align-items:center;gap:6px}
    .cycle{font-family:"JetBrains Mono";font-weight:800;font-size:12px;color:var(--gr);background:rgba(16,185,129,.1);
      border:1px solid rgba(16,185,129,.2);padding:4px 10px;border-radius:999px}
    .clock{font-family:"JetBrains Mono";font-weight:800;font-size:26px;color:var(--or)}
    .clockSub{font-size:11px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:1px;text-align:right}

    /* Tabs */
    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;
      background:rgba(15,23,36,.65);
      border:1px solid var(--border);
      border-radius:999px;padding:8px;
    }
    .tab{
      border:0;cursor:pointer;border-radius:999px;
      padding:10px 14px;font-weight:900;font-size:11px;letter-spacing:.8px;text-transform:uppercase;
      background:transparent;color:var(--muted);
      display:flex;gap:8px;align-items:center;
    }
    .tab[aria-selected="true"]{
      background:rgba(59,130,246,.18);
      border:1px solid rgba(59,130,246,.35);
      color:var(--text);
    }

    /* Panels */
    .panel{
      display:none;
      background:var(--card); border:1px solid var(--border); border-radius:var(--r); box-shadow:var(--shadow);
      padding:16px;
    }
    .panel.active{display:block}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:950px){.grid2{grid-template-columns:1fr}}

    .card{
      background:rgba(15,23,36,.6);
      border:1px solid var(--border);border-radius:var(--r);padding:14px;
    }
    .card h3{margin:0 0 10px 0;font-size:13px;font-weight:900;text-transform:uppercase;letter-spacing:.6px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    label{font-size:10px;font-weight:900;letter-spacing:.7px;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:6px}
    input{
      background:var(--input);border:1px solid var(--border);border-radius:10px;
      padding:10px 12px;color:var(--text);font-weight:800;min-width:180px
    }
    input::placeholder{color:#506079}
    
    .btn{
      border:0;cursor:pointer;border-radius:10px;padding:10px 12px;font-weight:900;font-size:11px;
      text-transform:uppercase;letter-spacing:.7px;display:inline-flex;gap:8px;align-items:center;justify-content:center;
    }
    .btn.pri{background:var(--pri);color:#fff}
    .btn.pu{background:var(--pu);color:#fff}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
    .btn.rd{background:rgba(239,68,68,.15);color:var(--rd);border:1px solid rgba(239,68,68,.35)}
    .btn.small { padding: 6px 10px; font-size: 10px; border-radius: 6px; }
    .btn:hover { filter: brightness(1.2); }
    .btn:active{transform:translateY(1px)}

    /* Filtros Cia / Gerador Escala */
    .filter-wrapper { display: flex; gap: 5px; background: var(--input); padding: 4px; border-radius: 10px; border: 1px solid var(--border); height: 38px;} /* Altura corrigida para 38px */
    .btn-filter { flex: 1; background: transparent; color: var(--muted); padding: 0 12px; font-size: 11px; border:0; border-radius:6px; cursor:pointer; font-weight:800; white-space: nowrap;} /* white-space: nowrap impede a quebra de linha */
    .btn-filter:hover { background: rgba(255,255,255,0.05); }
    .btn-filter.active { background: #334155; color: white; }
    .btn-filter[data-cia="LATAM"].active { background: #1B0088; color: white; border:none; }
    .btn-filter[data-cia="GOL"].active { background: #FF5E00; color: white; border:none; }
    .btn-filter[data-cia="AZUL"].active { background: #0055A4; color: white; border:none; }

    /* Table */
    .tableWrap{overflow:auto;border:1px solid var(--border);border-radius:var(--r)}
    table{border-collapse:separate;border-spacing:0;min-width:1050px;width:100%}
    th{
      background:#0f172a;color:var(--muted);font-size:10px;text-transform:uppercase;letter-spacing:1px;
      text-align:left;padding:12px 14px;border-bottom:2px solid var(--border)
    }
    td{
      background:var(--card);padding:12px 14px;border-bottom:1px solid var(--border);font-size:13px; vertical-align: middle;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover td{background:#1e293b}
    
    .mono{font-family:"JetBrains Mono";font-weight:900}
    .empty{padding:30px;text-align:center;color:var(--muted);font-style:italic}

    /* Elementos das Tabelas da V7.0 */
    .col-flight { font-family: 'JetBrains Mono', monospace; font-weight: 800; color: var(--cy); font-size: 14px; cursor: pointer;}
    .col-flight:hover { text-decoration: underline; color: #fff; }
    .cia-badge { padding: 4px 8px; border-radius: 4px; color: white; font-weight: 800; font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; }
    .time-pill {
        display: inline-flex; flex-direction: column; align-items: center; justify-content: center;
        background: var(--input); color: var(--pri); border: 1px solid var(--border);
        padding: 6px 10px; border-radius: 6px; min-width: 75px; text-align:center;
    }
    .time-pill.arr { color: var(--gr); border-color: rgba(16, 185, 129, 0.2); }
    .tp-utc { font-size: 9px; opacity: 0.8; font-family: 'JetBrains Mono'; margin-bottom: 2px; color: var(--muted); }
    .tp-local { font-size: 14px; font-weight: 800; font-family: 'JetBrains Mono'; line-height: 1; }
    .col-fl { font-family: 'JetBrains Mono'; font-weight: 700; color: var(--pu); background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.2); padding: 4px 8px; border-radius: 4px; font-size: 11px; text-align: center; }

    /* Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .modal-content { background: var(--card); padding: 30px; border-radius: var(--r); width: 90%; max-width: 600px; border: 1px solid var(--border); box-shadow: var(--shadow); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
    .modal-title { font-size: 20px; font-weight: 800; color: var(--text); font-family: 'JetBrains Mono';}
    .close-modal { font-size: 24px; color: var(--muted); background: none; padding: 0; border: none; cursor: pointer; }
    .close-modal:hover { color: var(--rd); }
    .detail-row { display: flex; padding: 12px 0; border-bottom: 1px dashed var(--border); }
    .detail-label { width: 140px; font-weight: 700; color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
    .detail-val { flex: 1; font-family: 'JetBrains Mono'; font-weight: 700; color: var(--cy); }

  </style>
</head>

<body>
  <div class="shell">

    <header class="topbar">
      <div class="brand">
        <h1>RPL Dispatch <span>7.1</span></h1>
        <div class="sub">Commercial Ops Dashboard</div>
      </div>

      <div class="center">
        <div class="cycle" id="validity-box">CYCLE: ---</div>
      </div>

      <div style="text-align:right">
        <div class="clock" id="brt-clock">00:00:00</div>
        <div class="clockSub" id="brt-date">---</div>
      </div>
    </header>

    <nav class="tabs" role="tablist" aria-label="Dispatch Tabs">
      <button class="tab" role="tab" data-tab="dashboard" aria-selected="true">üß≠ Dashboard</button>
      <button class="tab" role="tab" data-tab="board" aria-selected="false">üìã Voos</button>
      <button class="tab" role="tab" data-tab="roster" aria-selected="false">üìÖ Escala</button>
      <button class="tab" role="tab" data-tab="hangar" aria-selected="false">‚úàÔ∏è Hangar</button>
      <button class="tab" role="tab" data-tab="logbook" aria-selected="false">üìñ Logbook</button>
      <button class="tab" role="tab" data-tab="settings" aria-selected="false">‚öôÔ∏è Config</button>
    </nav>

    <section class="panel active" id="tab-dashboard" role="tabpanel">
      <div class="grid2">
        <div class="card">
          <h3>Status</h3>
          <div class="row">
            <div class="card" style="flex:1">
              <div style="font-size:10px;color:var(--muted);font-weight:900;text-transform:uppercase;letter-spacing:.8px">BANCO RPL</div>
              <div class="mono" id="db-status" style="font-size:18px;margin-top:8px;color:var(--gr)">ONLINE</div>
            </div>
            <div class="card" style="flex:1">
              <div style="font-size:10px;color:var(--muted);font-weight:900;text-transform:uppercase;letter-spacing:.8px">TOTAL VOOS</div>
              <div class="mono" id="db-count" style="font-size:18px;margin-top:8px">0</div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Acesso r√°pido</h3>
          <div class="row" style="gap:15px;">
            <button class="btn pri" onclick="switchTab('board')">üìã Buscar Voos</button>
            <button class="btn pu" onclick="switchTab('roster')">üìÖ Ver Escala</button>
            <button class="btn ghost" onclick="switchTab('hangar')">‚úàÔ∏è Meu Hangar</button>
            <button class="btn ghost" onclick="switchTab('logbook')">üìñ Abrir Logbook</button>
          </div>
        </div>
      </div>
    </section>

    <section class="panel" id="tab-board" role="tabpanel">
      
      <div class="grid2">
        <div class="card">
            <h3>Filtros Avan√ßados e Escalas</h3>
            <div class="row">
                <div>
                    <label>Companhia A√©rea</label>
                    <div class="filter-wrapper">
                        <button class="btn-filter active" onclick="setFilter('todas', this)">Todas</button>
                        <button class="btn-filter" data-cia="LATAM" onclick="setFilter('LATAM', this)">Latam</button>
                        <button class="btn-filter" data-cia="GOL" onclick="setFilter('GOL', this)">Gol</button>
                        <button class="btn-filter" data-cia="AZUL" onclick="setFilter('AZUL', this)">Azul</button>
                    </div>
                </div>
                <div>
                    <label>Gerar Escala Auto</label>
                    <div class="filter-wrapper">
                        <button class="btn-filter" onclick="generateRealTimeChain(1)">1 Perna</button>
                        <button class="btn-filter" onclick="generateRealTimeChain(2)">2 Pernas</button>
                        <button class="btn-filter" onclick="generateRealTimeChain(3)">3 Pernas</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Busca de Rotas (Sempre pelo .txt)</h3>
            <div class="row">
                <div>
                    <label>Origem (ICAO)</label>
                    <input id="airport-search" placeholder="Ex: SBGR" style="width: 140px; min-width: auto;" onkeydown="if(event.key==='Enter') searchFlights()"/>
                </div>
                <div>
                    <label>Destino (Opcional)</label>
                    <input id="destination-search" placeholder="Ex: SBSP" style="width: 140px; min-width: auto;" onkeydown="if(event.key==='Enter') searchFlights()"/>
                </div>
                <div>
                    <label>N¬∫ VOO</label>
                    <input id="search-input" placeholder="Ex: 1234" style="width: 120px; min-width: auto;" onkeydown="if(event.key==='Enter') manualSearch()"/>
                </div>
            </div>
            <div class="row" style="margin-top: 15px;">
                <button class="btn pu" onclick="searchFlights()">üîé BUSCAR VOOS</button>
                <button class="btn pri" onclick="manualSearch()">BUSCAR POR N¬∫ VOO</button>
                <button class="btn ghost" onclick="resetPanel()">üßπ Limpar</button>
            </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Quadro de voos dispon√≠veis</h3>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="text-align:center">A√ß√µes</th>
                <th>Voo</th>
                <th>Cia</th>
                <th>Aeronave</th>
                <th>Dias</th>
                <th>Origem</th>
                <th style="text-align:center;">Partida (Z / BRT)</th>
                <th>Destino</th>
                <th style="text-align:center;">Chegada (Z / BRT)</th>
                <th style="text-align:center">FL</th>
                <th>Rota</th>
              </tr>
            </thead>
            <tbody id="board-content"></tbody>
          </table>
          <div class="empty" id="empty-msg">Selecione uma base ou utilize os filtros acima.</div>
        </div>
      </div>
    </section>

    <section class="panel" id="tab-roster" role="tabpanel">
      <div class="card">
        <h3>Minha Escala <span id="roster-badge" style="background:var(--cy); color:#000; padding:2px 8px; border-radius:10px; font-size:12px; margin-left:10px;">0</span></h3>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="text-align:center">Gerenciar</th>
                <th>Voo</th>
                <th>Cia</th>
                <th>Aeronave</th>
                <th>Dias</th>
                <th>Origem</th>
                <th style="text-align:center;">Partida (Z / BRT)</th>
                <th>Destino</th>
                <th style="text-align:center;">Chegada (Z / BRT)</th>
                <th style="text-align:center">FL</th>
                <th>Rota</th>
              </tr>
            </thead>
            <tbody id="roster-body"></tbody>
          </table>
          <div class="empty" id="roster-empty">Nenhum voo na escala. Adicione atrav√©s do quadro de voos.</div>
        </div>
      </div>
    </section>

    <section class="panel" id="tab-hangar" role="tabpanel">
      <div class="card">
        <h3>Adicionar ao Hangar</h3>
        <div class="row">
          <div>
            <label>Cia A√©rea</label>
            <input id="hangar-cia" placeholder="Ex: AZUL" style="text-transform:uppercase"/>
          </div>
          <div>
            <label>Tipo (Aeronave)</label>
            <input id="hangar-type" placeholder="Ex: B738" style="text-transform:uppercase"/>
          </div>
          <div>
            <label>Local (ICAO)</label>
            <input id="hangar-loc" placeholder="Ex: SBSP" style="text-transform:uppercase"/>
          </div>
          <button class="btn pri" onclick="addAircraftToHangar()" style="height: 38px;">‚ûï Adicionar Aeronave</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Minha Frota Estacionada</h3>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Cia A√©rea</th>
                <th>Tipo</th>
                <th>Localiza√ß√£o Atual</th>
                <th style="text-align:center">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="hangar-body"></tbody>
          </table>
          <div class="empty" id="hangar-empty">Seu hangar est√° vazio.</div>
        </div>
      </div>
    </section>

    <section class="panel" id="tab-logbook" role="tabpanel">
      <div class="grid2">
        <div class="card">
          <h3>Estat√≠sticas</h3>
          <div class="row">
            <div class="card" style="flex:1">
              <div style="font-size:10px;color:var(--muted);font-weight:900;text-transform:uppercase;letter-spacing:.8px">Total de Voos</div>
              <div class="mono" id="stats-count" style="font-size:22px;margin-top:8px; color:var(--cy)">0</div>
            </div>
            <div class="card" style="flex:1">
              <div style="font-size:10px;color:var(--muted);font-weight:900;text-transform:uppercase;letter-spacing:.8px">Horas Voadas</div>
              <div class="mono" id="stats-hours" style="font-size:22px;margin-top:8px;color:var(--gr)">00h 00m</div>
            </div>
          </div>
          <div class="row" style="margin-top:15px">
            <input type="file" id="backup-file-input" style="display:none" onchange="restoreLogbook(event)" />
            <button class="btn ghost" onclick="backupLogbook()">‚¨áÔ∏è Fazer Backup</button>
            <button class="btn ghost" onclick="document.getElementById('backup-file-input').click()">‚¨ÜÔ∏è Restaurar</button>
            <button class="btn rd" onclick="clearLogbook()">üóëÔ∏è Limpar Tudo</button>
          </div>
        </div>

        <div class="card">
          <h3>Registros</h3>
          <div class="tableWrap">
            <table style="min-width:900px">
              <thead>
                <tr>
                  <th>Data</th><th>Voo</th><th>Origem</th><th>Destino</th><th>Tempo</th><th>Aeronave</th><th style="text-align:center">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="logbook-body"></tbody>
            </table>
            <div class="empty" id="logbook-empty">Nenhum registro ainda. Os voos despachados via Simbrief aparecer√£o aqui.</div>
          </div>
        </div>
      </div>
    </section>

    <section class="panel" id="tab-settings" role="tabpanel">
      <div class="card">
        <h3>Configura√ß√µes de Integra√ß√£o</h3>
        <div class="row">
          <div>
            <label>SimBrief ID</label>
            <input id="sb-id" placeholder="Ex: 123456" oninput="saveSBID()" />
          </div>
          <div class="card" style="flex:1; background: var(--input);">
            <div style="font-size:11px;color:var(--muted);font-weight:800;line-height:1.6">
              ‚úÖ <b>Regra:</b> O sistema envia a Rota, Callsign, Equipamento e N√≠vel de Voo (FL) extra√≠dos puramente do RPL.<br/>
              ‚úÖ <b>Hor√°rios:</b> O SimBrief recebe os hor√°rios UTC do RPL processados automaticamente.<br/>
              ‚úÖ A base de dados funciona 100% offline ap√≥s o primeiro carregamento dos .TXT.
            </div>
          </div>
        </div>
      </div>
    </section>

  </div>

  <div id="flight-modal" class="modal-overlay">
      <div class="modal-content">
          <div class="modal-header">
              <div class="modal-title">
                  <span id="modal-cia-badge" class="cia-badge" style="font-size:14px;">CIA</span>
                  <span id="modal-flight-num" style="margin-left:10px;">VOO 1234</span>
              </div>
              <button class="close-modal" aria-label="Fechar" onclick="closeModal()">√ó</button>
          </div>
          
          <div id="modal-body">
              <div class="detail-row"><span class="detail-label">Aeronave</span> <span class="detail-val" id="md-acft"></span></div>
               <div class="detail-row"><span class="detail-label">Rota Completa</span> <span class="detail-val" id="md-route" style="font-size:12px;"></span></div>
               <div class="detail-row"><span class="detail-label">Trecho</span> <span class="detail-val" id="md-deparr"></span></div>
               <div class="detail-row"><span class="detail-label">Tempo Estimado</span> <span class="detail-val" id="md-eet"></span></div>
               <div class="detail-row"><span class="detail-label">N√≠vel (FL)</span> <span class="detail-val" id="md-fl"></span></div>
               <div class="detail-row"><span class="detail-label">Dias de Opera√ß√£o</span> <span class="detail-val" id="md-days" style="color:var(--text);"></span></div>
               <div class="detail-row" style="border-bottom:none;"><span class="detail-label">Observa√ß√µes</span> <span class="detail-val" id="md-obs" style="color:var(--muted); font-size:11px;"></span></div>
          </div>
      </div>
  </div>

  <script>
    // === NAVEGA√á√ÉO POR ABAS ===
    const tabs = document.querySelectorAll('.tab');
    const panels = document.querySelectorAll('.panel');

    function switchTab(targetId) {
        tabs.forEach(t => t.setAttribute('aria-selected', 'false'));
        panels.forEach(p => p.classList.remove('active'));

        const targetTab = document.querySelector(`.tab[data-tab="${targetId}"]`);
        if(targetTab) targetTab.setAttribute('aria-selected', 'true');
        
        const targetPanel = document.getElementById(`tab-${targetId}`);
        if(targetPanel) targetPanel.classList.add('active');

        // Renderiza itens pesados caso precise de refresh ao abrir a aba
        if(targetId === 'dashboard') {
          updateDatabaseStatus(); 
        }
        if(targetId === 'hangar') renderHangar();
        if(targetId === 'logbook') renderLogbook();
        if(targetId === 'roster') renderRoster();
    }

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            switchTab(tab.getAttribute('data-tab'));
        });
    });

    // === L√ìGICA DO SISTEMA ===
    const USE_REAL_TIME_DATE = true; 
    const SIMULATE_DATE_FIXED = "2026-02-07"; 
    const TURNAROUND_MINUTES = 45; 

    const airlineConfig = [
        { id: 'LATAM', name: 'LATAM', file: 'Cia_TAM_CS.txt', color: '#1B0088' },
        { id: 'GOL', name: 'GOL', file: 'Cia_GLO_CS.txt', color: '#FF5E00' },
        { id: 'AZUL', name: 'AZUL', file: 'Cia_AZU_CS.txt', color: '#0055A4' }
    ];

    let allFlightsDB = [];
    let currentFilter = 'todas';
    let displayedFlights = [];
    let validityUpdated = false;

    function getSafeStorage(key) {
        try {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        } catch (e) { return []; }
    }

    document.addEventListener("DOMContentLoaded", () => {
        const savedID = localStorage.getItem("simbrief_id");
        if (savedID) document.getElementById("sb-id").value = savedID;
        renderHangar();
        renderLogbook();
        renderRoster();
        loadAllFiles(); 
    });

    function saveSBID() {
        localStorage.setItem("simbrief_id", document.getElementById("sb-id").value);
    }

    // --- INTEGRA√á√ÉO SIMBRIEF ---
    function openSimBriefWithData(flight) {
        const sbID = document.getElementById("sb-id").value;
        if (!sbID) {
            alert("Preencha o ID do SimBrief na aba de Configura√ß√µes.");
            switchTab('settings');
            document.getElementById("sb-id").focus();
            return;
        }

        saveToLogbook(flight);

        const airlineCode = flight.ident.match(/^[A-Z]+/)[0];
        const fltNumber = flight.ident.match(/\d+/)[0];
        let cleanType = flight.type.split('/')[0]; 
        const routeEncoded = encodeURIComponent(flight.rota);

        let hours = Math.floor(flight.depMinUTC / 60);
        let minutes = flight.depMinUTC % 60;
        if (hours >= 24) hours = hours % 24;

        const dateObj = getSimulationDate(); 
        if (flight.offsetDay) {
            dateObj.setDate(dateObj.getDate() + flight.offsetDay);
        }
        
        let depMinBRT = flight.depMinUTC - 180;
        if (depMinBRT < 0) depMinBRT += 1440;
        dateObj.setHours(Math.floor(depMinBRT / 60), depMinBRT % 60, 0, 0);

        const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
        const day = String(dateObj.getUTCDate()).padStart(2, '0');
        const month = monthNames[dateObj.getUTCMonth()];
        const year = String(dateObj.getUTCFullYear()).slice(-2); 
        const sbDate = `${day}${month}${year}`;

        const url = `https://www.simbrief.com/system/dispatch.php?userid=${sbID}&airline=${airlineCode}&fltnum=${fltNumber}&orig=${flight.origin}&dest=${flight.dest}&route=${routeEncoded}&type=${cleanType}&date=${sbDate}&deph=${hours}&depm=${minutes}&fl=${flight.fl}`;
        window.open(url, '_blank');
    }

    function openSimBriefFromIndex(index) {
        const flight = displayedFlights[index];
        if (!flight) return;
        openSimBriefWithData(flight);
    }

    // --- BUSCA E FILTROS ---
    function resetPanel() {
        document.getElementById('board-content').innerHTML = '';
        document.getElementById('empty-msg').style.display = 'block';
        document.getElementById('empty-msg').innerText = "Painel limpo. Selecione os filtros acima.";
        document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
        
        document.getElementById('search-input').value = '';
        document.getElementById('airport-search').value = '';
        document.getElementById('destination-search').value = '';
        
        displayedFlights = [];
    }

    function setFilter(filterName, btnElement) {
        document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');
        currentFilter = filterName;
    }

    function getUpcomingFlights(orig, dest = null, ciaFilter = 'todas', maxHours = 48) {
        const now = getSimulationDate();
        const currentBRTMinutes = (now.getHours() * 60) + now.getMinutes();
        const currentLocalDay = now.getDay();
        const rplCurrentLocalDayIdx = currentLocalDay === 0 ? 6 : currentLocalDay - 1; 
        
        let results = [];
        allFlightsDB.forEach(f => {
            if (orig && f.origin !== orig) return;
            if (dest && f.dest !== dest) return;
            if (ciaFilter !== 'todas' && f.airline.name !== ciaFilter) return;

            let depMinBRT = f.depMinUTC - 180;
            if (depMinBRT < 0) depMinBRT += 1440;

            for (let offset = 0; offset <= 2; offset++) {
                const checkLocalDayIdx = (rplCurrentLocalDayIdx + offset) % 7;
                let utcDayIdx = checkLocalDayIdx;
                if (f.depMinUTC < 180) { utcDayIdx = (checkLocalDayIdx + 1) % 7; }

                if (f.daysOp.charAt(utcDayIdx) !== '0' && f.daysOp.charAt(utcDayIdx) !== ' ') {
                    let minsFromNow = (offset * 1440) + depMinBRT - currentBRTMinutes;
                    if (minsFromNow >= 0 && minsFromNow <= (maxHours * 60)) { 
                        results.push({ ...f, offsetDay: offset, sortMins: minsFromNow });
                    }
                }
            }
        });
        results.sort((a, b) => a.sortMins - b.sortMins);
        return results;
    }

    function manualSearch() {
        const rawInput = document.getElementById('search-input').value;
        const input = rawInput ? rawInput.toUpperCase().replace(/\s+/g, '') : "";

        if (input.length < 3) { alert("Digite pelo menos 3 caracteres."); return; }
        if(allFlightsDB.length === 0) { alert("Aguarde o carregamento."); return; }

        const now = getSimulationDate();
        const currentBRTMinutes = (now.getHours() * 60) + now.getMinutes();
        const currentLocalDay = now.getDay();
        const rplCurrentLocalDayIdx = currentLocalDay === 0 ? 6 : currentLocalDay - 1;

        let matches = [];
        allFlightsDB.forEach(f => {
            if (f.ident.includes(input)) {
                let depMinBRT = f.depMinUTC - 180;
                if (depMinBRT < 0) depMinBRT += 1440;

                for (let offset = 0; offset <= 2; offset++) {
                    const checkLocalDayIdx = (rplCurrentLocalDayIdx + offset) % 7;
                    let utcDayIdx = checkLocalDayIdx;
                    if (f.depMinUTC < 180) utcDayIdx = (checkLocalDayIdx + 1) % 7;

                    if (f.daysOp.charAt(utcDayIdx) !== '0' && f.daysOp.charAt(utcDayIdx) !== ' ') {
                        let minsFromNow = (offset * 1440) + depMinBRT - currentBRTMinutes;
                        if(minsFromNow > -1440 && minsFromNow <= 2880) {
                            matches.push({ ...f, offsetDay: offset, sortMins: minsFromNow });
                        }
                    }
                }
            }
        });

        if (matches.length === 0) { alert("Voo n√£o encontrado."); return; }

        matches.sort((a,b) => a.sortMins - b.sortMins);
        displayedFlights = matches.map(f => enrichFlightData(f));
        renderRows(displayedFlights);
        document.getElementById('empty-msg').style.display = 'none';
    }

    function searchFlights() {
        const rawOrig = document.getElementById('airport-search').value;
        const orig = rawOrig ? rawOrig.toUpperCase().trim() : "";
        const rawDest = document.getElementById('destination-search').value;
        const dest = rawDest ? rawDest.toUpperCase().trim() : "";
        
        if (orig.length < 3) { alert("Preencha pelo menos 3 caracteres na Origem (Ex: SBGR)."); return; }
        if(allFlightsDB.length === 0) { alert("Aguarde o carregamento da malha."); return; }

        const matches = getUpcomingFlights(orig, dest.length >= 3 ? dest : null, currentFilter, 48);

        if (matches.length === 0) {
            if (dest.length >= 3) alert(`Nenhum voo direto encontrado de ${orig} para ${dest} nas pr√≥ximas 48 horas.`);
            else alert(`Nenhuma partida encontrada saindo de ${orig} nas pr√≥ximas 48 horas.`);
            return;
        }

        displayedFlights = matches.map(f => enrichFlightData(f));
        renderRows(displayedFlights);
        document.getElementById('empty-msg').style.display = 'none';
    }

    function generateRealTimeChain(chainLength) {
        const orig = document.getElementById('airport-search').value.toUpperCase().trim();
        
        let candidates = getUpcomingFlights(orig.length >= 3 ? orig : null, null, currentFilter, 24);
        if (candidates.length === 0) { alert("Sem voos dispon√≠veis nas pr√≥ximas horas."); return; }
        
        let seedCandidates = candidates.filter(f => f.sortMins >= 30 && f.sortMins <= 180);
        if (seedCandidates.length === 0) seedCandidates = candidates;

        const seed = seedCandidates[Math.floor(Math.random() * Math.min(15, seedCandidates.length))];
        let chain = [enrichFlightData(seed)];

        for (let i = 1; i < chainLength; i++) {
            const prev = chain[i-1];
            const prevArrMinsFromNow = prev.sortMins + prev.durMin;
            const minNextDepMinsFromNow = prevArrMinsFromNow + TURNAROUND_MINUTES;
            
            let nextLegs = getUpcomingFlights(prev.dest, null, prev.airline.name, 48);
            nextLegs = nextLegs.filter(f => f.sortMins >= minNextDepMinsFromNow);
            
            if (nextLegs.length > 0) chain.push(enrichFlightData(nextLegs[0]));
            else break;
        }
        
        displayedFlights = chain;
        renderRows(chain);
        document.getElementById('empty-msg').style.display = 'none';
    }

    function enrichFlightData(flight) {
        const toBRT = (utc) => { let b = utc - 180; if(b<0) b+=1440; if(b>=1440) b-=1440; return b; };
        const depMinBRT = toBRT(flight.depMinUTC);
        const arrMinBRT = toBRT(flight.arrMinUTC);
        let arrUtc = flight.arrMinUTC >= 1440 ? flight.arrMinUTC - 1440 : flight.arrMinUTC;
        let nextDay = arrMinBRT < depMinBRT;
        
        let depPrefix = "";
        if (flight.offsetDay === 1) depPrefix = `<span style="color:var(--or); font-size:9px; display:block; margin-bottom:2px; font-weight:800; letter-spacing:1px;">AMANH√É</span>`;
        else if (flight.offsetDay > 1) depPrefix = `<span style="color:var(--or); font-size:9px; display:block; margin-bottom:2px; font-weight:800; letter-spacing:1px;">+${flight.offsetDay} DIAS</span>`;

        return {
            ...flight,
            depDisplay: minutesToTimeStr(depMinBRT),
            arrDisplay: minutesToTimeStr(arrMinBRT),
            depDisplayUTC: minutesToTimeStr(flight.depMinUTC),
            arrDisplayUTC: minutesToTimeStr(arrUtc),
            isNextDay: nextDay,
            depPrefix: depPrefix
        };
    }

    function timeStrToMinutes(str) { return (parseInt(str.substring(0,2))*60) + parseInt(str.substring(2,4)); }

    function minutesToTimeStr(min) {
        let h = Math.floor(min/60)%24; let m = Math.floor(min%60);
        return String(h).padStart(2,'0') + ":" + String(m).padStart(2,'0');
    }

    function formatDaysLocal(daysStr, depMinUTC) {
        if (!daysStr) return "N/A";
        const labels = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'];
        let localDaysActive = [false, false, false, false, false, false, false];
        let shift = depMinUTC < 180 ? -1 : 0;
        for (let i = 0; i < daysStr.length; i++) {
            if (daysStr[i] !== ' ' && daysStr[i] !== '0') {
                let localDayIdx = (i + shift + 7) % 7;
                localDaysActive[localDayIdx] = true;
            }
        }
        let active = [];
        for (let i = 0; i < 7; i++) { if (localDaysActive[i]) active.push(labels[i]); }
        return active.length > 0 ? active.join(', ') : "N√£o especificado";
    }

    function scheduleFlight(index) {
        const flight = displayedFlights[index];
        if (!flight) return;
        let roster = getSafeStorage('myPilotRoster');
        roster.push({ id: Date.now(), flightData: flight });
        roster.sort((a, b) => (a.flightData.sortMins || 0) - (b.flightData.sortMins || 0));
        localStorage.setItem('myPilotRoster', JSON.stringify(roster));
        renderRoster();
    }

    function renderRows(flights) {
        const tbody = document.getElementById('board-content');
        tbody.innerHTML = '';
        flights.forEach((f, index) => {
            const tr = document.createElement('tr');
            
            const sbButton = `<button class="btn pu small" title="Abrir no SimBrief" onclick="openSimBriefFromIndex(${index})">Simbrief ‚Üó</button>`;
            const scheduleButton = `<button class="btn pri small" title="Agendar na escala" onclick="scheduleFlight(${index})">‚ûï</button>`;
            
            const arrHtml = f.isNextDay ? `<span style="color:var(--or); font-size:9px; display:block; margin-top:2px;">(+1)</span>` : ``;
            const depCell = `<div class="time-pill">${f.depPrefix || ''}<div class="tp-utc">${f.depDisplayUTC}z</div><div class="tp-local">${f.depDisplay}</div></div>`;
            const arrCell = `<div class="time-pill arr"><div class="tp-utc">${f.arrDisplayUTC}z</div><div class="tp-local">${f.arrDisplay}</div>${arrHtml}</div>`;
            const acftType = f.type.split('/')[0];

            tr.innerHTML = `
                <td><div style="display:flex; gap:5px; justify-content:center;">${sbButton}${scheduleButton}</div></td>
                <td class="col-flight" onclick="showFlightDetails(${index})">${f.ident}</td>
                <td><span class="cia-badge" style="background-color: ${f.airline.color}">${f.airline.name}</span></td>
                <td style="font-weight:800; font-family:'JetBrains Mono';">${acftType}</td>
                <td style="font-size: 11px; color: var(--muted); max-width: 120px;">${formatDaysLocal(f.daysOp, f.depMinUTC)}</td>
                <td style="font-weight:800; font-family:'JetBrains Mono'; font-size: 15px;">${f.origin}</td>
                <td style="text-align:center;">${depCell}</td>
                <td style="font-weight:800; font-family:'JetBrains Mono'; font-size: 15px;">${f.dest}</td>
                <td style="text-align:center;">${arrCell}</td>
                <td class="col-fl">${f.fl}</td>
                <td style="font-family:'JetBrains Mono'; font-size: 11px; color: var(--muted); max-width:250px;">${f.rota}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderRoster() {
        const roster = getSafeStorage('myPilotRoster');
        const tbody = document.getElementById('roster-body');
        const emptyMsg = document.getElementById('roster-empty');
        
        document.getElementById('roster-badge').innerText = roster.length;

        tbody.innerHTML = '';
        if (roster.length === 0) { emptyMsg.style.display = 'block'; return; }
        else { emptyMsg.style.display = 'none'; }

        roster.forEach(entry => {
            const f = entry.flightData;
            const tr = document.createElement('tr');
            
            const sbButton = `<button class="btn pu small" title="Abrir no SimBrief" onclick="dispatchRosterFlight(${entry.id})">Simbrief ‚Üó</button>`;
            const removeButton = `<button class="btn rd small" title="Remover da Escala" onclick="deleteRosterEntry(${entry.id})">‚úï</button>`;

            const arrHtml = f.isNextDay ? `<span style="color:var(--or); font-size:9px; display:block; margin-top:2px;">(+1)</span>` : ``;
            const depCell = `<div class="time-pill">${f.depPrefix || ''}<div class="tp-utc">${f.depDisplayUTC}z</div><div class="tp-local">${f.depDisplay}</div></div>`;
            const arrCell = `<div class="time-pill arr"><div class="tp-utc">${f.arrDisplayUTC}z</div><div class="tp-local">${f.arrDisplay}</div>${arrHtml}</div>`;
            const acftType = f.type.split('/')[0];

            tr.innerHTML = `
                <td><div style="display:flex; gap:5px; justify-content:center;">${sbButton}${removeButton}</div></td>
                <td class="col-flight" onclick="showRosterFlightDetails(${entry.id})">${f.ident}</td>
                <td><span class="cia-badge" style="background-color: ${f.airline.color}">${f.airline.name}</span></td>
                <td style="font-weight:800; font-family:'JetBrains Mono';">${acftType}</td>
                <td style="font-size: 11px; color: var(--muted); max-width: 120px;">${formatDaysLocal(f.daysOp, f.depMinUTC)}</td>
                <td style="font-weight:800; font-family:'JetBrains Mono'; font-size: 15px;">${f.origin}</td>
                <td style="text-align:center;">${depCell}</td>
                <td style="font-weight:800; font-family:'JetBrains Mono'; font-size: 15px;">${f.dest}</td>
                <td style="text-align:center;">${arrCell}</td>
                <td class="col-fl">${f.fl}</td>
                <td style="font-family:'JetBrains Mono'; font-size: 11px; color: var(--muted); max-width:250px;">${f.rota}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function dispatchRosterFlight(id) {
        const roster = getSafeStorage('myPilotRoster');
        const entry = roster.find(e => e.id === id);
        if (entry) openSimBriefWithData(entry.flightData);
    }

    function deleteRosterEntry(id) {
        if(!confirm("Remover da escala?")) return;
        let roster = getSafeStorage('myPilotRoster');
        roster = roster.filter(e => e.id !== id);
        localStorage.setItem('myPilotRoster', JSON.stringify(roster));
        renderRoster();
    }

    // --- LOGICA DO HANGAR ---
    function renderHangar() {
        const hangar = getSafeStorage('myPilotHangar');
        const tbody = document.getElementById('hangar-body');
        const emptyMsg = document.getElementById('hangar-empty');
        
        tbody.innerHTML = '';
        if (hangar.length === 0) { emptyMsg.style.display = 'block'; return; }
        else { emptyMsg.style.display = 'none'; }

        hangar.forEach(acft => {
            const displayCia = acft.cia || acft.reg || 'N/A';
            const badgeColor = displayCia === 'LATAM' ? '#1B0088' : (displayCia === 'GOL' ? '#FF5E00' : (displayCia === 'AZUL' ? '#0055A4' : 'var(--border)'));

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span class="cia-badge" style="background-color: ${badgeColor}; padding: 6px 12px; font-size: 11px;">${displayCia}</span></td>
                <td style="font-weight:800; font-size: 15px; font-family: 'JetBrains Mono';">${acft.type}</td>
                <td style="font-weight:800; font-size: 15px; font-family: 'JetBrains Mono'; color:var(--cy);">${acft.loc}</td>
                <td>
                    <div style="display:flex; gap:5px; justify-content:center;">
                        <button class="btn pri small" title="Procurar voos saindo daqui" onclick="flyFromHangar('${acft.loc}', '${displayCia}')">üõ´ VOAR DAQUI</button>
                        <button class="btn rd small" title="Remover do Hangar" onclick="removeAircraftFromHangar(${acft.id})">üóëÔ∏è</button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function addAircraftToHangar() {
        const cia = document.getElementById('hangar-cia').value.toUpperCase().trim();
        const type = document.getElementById('hangar-type').value.toUpperCase().trim();
        const loc = document.getElementById('hangar-loc').value.toUpperCase().trim();

        if(!cia || !type || !loc) { alert("Preencha Cia, Tipo e Localiza√ß√£o (ICAO)."); return; }
        if(loc.length !== 4) { alert("O ICAO deve ter exatamente 4 letras (Ex: SBGR)."); return; }

        let hangar = getSafeStorage('myPilotHangar');
        hangar.push({ id: Date.now(), cia, type, loc });
        localStorage.setItem('myPilotHangar', JSON.stringify(hangar));
        
        document.getElementById('hangar-cia').value = '';
        document.getElementById('hangar-type').value = '';
        document.getElementById('hangar-loc').value = '';
        
        renderHangar();
    }

    function removeAircraftFromHangar(id) {
        if(!confirm("Tem certeza que deseja remover esta aeronave do hangar?")) return;
        let hangar = getSafeStorage('myPilotHangar');
        hangar = hangar.filter(a => a.id !== id);
        localStorage.setItem('myPilotHangar', JSON.stringify(hangar));
        renderHangar();
    }

    function flyFromHangar(loc, cia) {
        document.getElementById('airport-search').value = loc;
        document.getElementById('destination-search').value = '';
        
        const btn = document.querySelector(`.btn-filter[data-cia="${cia}"]`);
        if (btn) setFilter(cia, btn);
        else {
            const allBtn = document.querySelector('.btn-filter');
            setFilter('todas', allBtn);
        }

        switchTab('board');
        searchFlights();
    }

    function parkFromLogbook(callsign, type, arrLoc) {
        let cia = "";
        if(callsign.startsWith("TAM") || callsign.startsWith("LTG")) cia = "LATAM";
        else if(callsign.startsWith("GLO")) cia = "GOL";
        else if(callsign.startsWith("AZU")) cia = "AZUL";
        else {
            const match = callsign.match(/^[A-Z]+/);
            cia = match ? match[0] : "DESCONHECIDA";
        }

        let hangar = getSafeStorage('myPilotHangar');
        hangar.push({ id: Date.now(), cia: cia, type: type.toUpperCase(), loc: arrLoc.toUpperCase() });
        localStorage.setItem('myPilotHangar', JSON.stringify(hangar));
        
        alert(`‚úàÔ∏è Aeronave da ${cia} (${type}) estacionada com sucesso em ${arrLoc}!`);
        renderHangar();
    }

    // --- LOGICA DO LOGBOOK ---
    function saveToLogbook(flight) {
        let logbook = getSafeStorage('myPilotLogbook');
        const now = new Date();
        const dateStr = now.toLocaleDateString('pt-BR');
        
        const durHours = Math.floor(flight.durMin / 60);
        const durMins = flight.durMin % 60;
        const durStr = String(durHours).padStart(2,'0') + ":" + String(durMins).padStart(2,'0');

        logbook.unshift({
            id: Date.now(),
            date: dateStr,
            callsign: flight.ident,
            dep: flight.origin,
            arr: flight.dest,
            time: durStr,
            acft: flight.type.split('/')[0]
        });
        localStorage.setItem('myPilotLogbook', JSON.stringify(logbook));
        renderLogbook();
    }

    function renderLogbook() {
        const logbook = getSafeStorage('myPilotLogbook');
        const tbody = document.getElementById('logbook-body');
        const emptyMsg = document.getElementById('logbook-empty');
        
        let totalMinutes = 0;
        logbook.forEach(e => {
            const parts = e.time.split(':');
            totalMinutes += (parseInt(parts[0]) * 60) + parseInt(parts[1]);
        });
        const totalH = Math.floor(totalMinutes / 60);
        const totalM = totalMinutes % 60;
        
        document.getElementById('stats-count').innerText = logbook.length;
        document.getElementById('stats-hours').innerText = `${String(totalH).padStart(2,'0')}h ${String(totalM).padStart(2,'0')}m`;

        tbody.innerHTML = '';
        if (logbook.length === 0) { emptyMsg.style.display = 'block'; return; }
        else { emptyMsg.style.display = 'none'; }

        logbook.forEach(entry => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="color:var(--muted);">${entry.date}</td>
                <td style="font-weight:800; color:var(--cy); font-family:'JetBrains Mono';">${entry.callsign}</td>
                <td style="font-family:'JetBrains Mono'; font-weight:700;">${entry.dep}</td>
                <td style="font-family:'JetBrains Mono'; font-weight:700;">${entry.arr}</td>
                <td style="color:var(--gr); font-weight:700;">${entry.time}</td>
                <td style="font-weight:700;">${entry.acft}</td>
                <td>
                    <div style="display:flex; gap:5px; justify-content:center;">
                        <button class="btn ghost small" title="Estacionar aeronave no Hangar" onclick="parkFromLogbook('${entry.callsign}', '${entry.acft}', '${entry.arr}')">üÖøÔ∏è HANGAR</button>
                        <button class="btn rd small" title="Apagar Registro" onclick="deleteLogbookEntry(${entry.id})">üóëÔ∏è</button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function deleteLogbookEntry(id) {
        if(!confirm("Excluir registro?")) return;
        let logbook = getSafeStorage('myPilotLogbook');
        logbook = logbook.filter(entry => entry.id !== id);
        localStorage.setItem('myPilotLogbook', JSON.stringify(logbook));
        renderLogbook();
    }

    function clearLogbook() {
        if(confirm("Apagar todo o hist√≥rico?")) {
            localStorage.removeItem('myPilotLogbook');
            renderLogbook();
        }
    }

    function backupLogbook() {
        const dataStr = JSON.stringify({
            version: "7.1",
            date: new Date().toISOString(),
            simbrief_id: localStorage.getItem('simbrief_id') || "",
            logbook: getSafeStorage('myPilotLogbook'),
            roster: getSafeStorage('myPilotRoster'),
            hangar: getSafeStorage('myPilotHangar')
        }, null, 2);
        
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_rpl_v7_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function restoreLogbook(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (data.logbook) {
                    if(confirm("Restaurar backup?")) {
                        localStorage.setItem('myPilotLogbook', JSON.stringify(data.logbook));
                        if (data.roster) localStorage.setItem('myPilotRoster', JSON.stringify(data.roster));
                        if (data.hangar) localStorage.setItem('myPilotHangar', JSON.stringify(data.hangar));
                        if (data.simbrief_id) {
                            localStorage.setItem('simbrief_id', data.simbrief_id);
                            document.getElementById('sb-id').value = data.simbrief_id;
                        }
                        renderLogbook();
                        renderRoster();
                        renderHangar();
                        alert("Restaurado com sucesso!");
                    }
                }
            } catch (err) { alert("Erro ao ler o arquivo de backup."); }
            event.target.value = '';
        };
        reader.readAsText(file);
    }

    // --- MODAL ---
    function openModalWithFlight(f) {
        document.getElementById('modal-cia-badge').innerText = f.airline.name;
        document.getElementById('modal-cia-badge').style.backgroundColor = f.airline.color;
        document.getElementById('modal-flight-num').innerText = f.ident;
        document.getElementById('md-acft').innerText = f.type;
        document.getElementById('md-route').textContent = f.rota; 
        document.getElementById('md-deparr').innerText = `${f.origin} -> ${f.dest}`;
        document.getElementById('md-eet').innerText = minutesToTimeStr(f.durMin).replace(':', 'h ') + 'm';
        document.getElementById('md-fl').innerText = f.fl;
        document.getElementById('md-days').innerText = formatDaysLocal(f.daysOp, f.depMinUTC);
        document.getElementById('md-obs').textContent = f.obs;
        document.getElementById('flight-modal').style.display = 'flex';
    }

    function showFlightDetails(index) {
        const f = displayedFlights[index];
        if (f) openModalWithFlight(f);
    }

    function showRosterFlightDetails(id) {
        const roster = getSafeStorage('myPilotRoster');
        const entry = roster.find(e => e.id === id);
        if (entry) openModalWithFlight(entry.flightData);
    }

    function closeModal() { document.getElementById('flight-modal').style.display = 'none'; }
    window.onclick = function(event) {
        if (event.target == document.getElementById('flight-modal')) closeModal();
    }

    // --- REL√ìGIO E DADOS ---
    function getSimulationDate() {
        if (USE_REAL_TIME_DATE) return new Date();
        const realNow = new Date();
        const [y, m, d] = SIMULATE_DATE_FIXED.split('-').map(Number);
        return new Date(y, m - 1, d, realNow.getHours(), realNow.getMinutes(), realNow.getSeconds());
    }

    function updateClock() {
        const now = getSimulationDate(); 
        const timeOptions = { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' };
        const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('brt-clock').innerText = now.toLocaleTimeString('pt-BR', timeOptions);
        document.getElementById('brt-date').innerText = now.toLocaleDateString('pt-BR', dateOptions).toUpperCase();
    }
    setInterval(updateClock, 1000);
    updateClock();

    function updateDatabaseStatus() {
        const dbCount = allFlightsDB.length;
        document.getElementById('db-count').innerText = dbCount; // Mostra apenas o n√∫mero real, sem fallback para 4

        const dbStatus = document.getElementById('db-status');
        if (dbCount > 0) {
            dbStatus.innerText = "ONLINE";
            dbStatus.style.color = "var(--gr)";
        } else {
            dbStatus.innerText = "Sincronizando..."; 
            dbStatus.style.color = "var(--cy)";
        }
    }

    async function loadAllFiles() {
        allFlightsDB = [];
        const dbStatus = document.getElementById('db-status');
        dbStatus.innerText = "Sincronizando...";
        dbStatus.style.color = "var(--cy)";
        
        try {
            const promises = airlineConfig.map(async (airline) => {
                try {
                    const response = await fetch(airline.file);
                    if (!response.ok) throw new Error("404");
                    const text = await response.text();
                    checkValidityDate(text);
                    const flights = parseRPLData(text, airline);
                    return { status: "OK", flights: flights };
                } catch (error) { return { status: "Erro", flights: [] }; }
            });
            const results = await Promise.all(promises);
            results.forEach(res => { if(res.flights.length > 0) allFlightsDB = allFlightsDB.concat(res.flights); });
            
            updateDatabaseStatus(); // Atualiza contador e status ap√≥s carregar

            if (allFlightsDB.length === 0) {
                dbStatus.innerText = "ERRO DE LEITURA";
                dbStatus.style.color = "var(--rd)";
            }
        } catch (e) {
            dbStatus.innerText = "FALHA";
            dbStatus.style.color = "var(--rd)";
        }
    }

    function checkValidityDate(text) {
        if (validityUpdated) return; 
        const regex = /IN[I√ç]CIO DE VALIDADE:\s*(\d{2})([a-z]{3})\.(\d{4})/i;
        const match = text.match(regex);
        if (match) {
            const day = parseInt(match[1]);
            const monthStr = match[2].toLowerCase();
            const year = parseInt(match[3]);
            const months = { 'jan':0, 'fev':1, 'mar':2, 'abr':3, 'mai':4, 'jun':5, 'jul':6, 'ago':7, 'set':8, 'out':9, 'nov':10, 'dez':11 };
            
            if (months[monthStr] !== undefined) {
                const startDate = new Date(year, months[monthStr], day);
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6); 
                const opts = { day: '2-digit', month: 'short', year: 'numeric' };
                const startFmt = startDate.toLocaleDateString('pt-BR', opts).toUpperCase().replace('.', '');
                const endFmt = endDate.toLocaleDateString('pt-BR', opts).toUpperCase().replace('.', '');
                const cleanStart = startFmt.replace(' DE ', ' ');
                const cleanEnd = endFmt.replace(' DE ', ' ');
                document.getElementById("validity-box").innerText = `CYCLE: ${cleanStart} - ${cleanEnd}`;
                validityUpdated = true;
            }
        }
    }

    function parseRPLData(textData, airlineInfo) {
        const lines = textData.split('\n');
        const flights = [];
        for (let line of lines) {
            line = line.trim();
            if (line.length < 50 || !/^\d{6}\s+\d{6}/.test(line)) continue;
            const parts = line.split(/\s+/);
            const speedIndex = parts.findIndex(p => /^[NM]\d{3,4}$/.test(p));
            if (speedIndex !== -1 && parts.length > speedIndex + 3) {
                try {
                    const daysOp = parts[2]; const ident = parts[3]; const type = parts[4];
                    const adepEobt = parts[speedIndex - 1]; 
                    const origin = adepEobt.substring(0, 4); const depTimeUTC = adepEobt.substring(4, 8); 
                    const fl = parts[speedIndex + 1];
                    let destIndex = parts.findIndex((p, idx) => idx > speedIndex && /^[A-Z]{4}\d{4}$/.test(p));
                    if (destIndex !== -1) {
                        const destEet = parts[destIndex];
                        const dest = destEet.substring(0, 4); const eetStr = destEet.substring(4, 8); 
                        const rota = parts.slice(speedIndex + 2, destIndex).join(' ');
                        const obs = parts.slice(destIndex + 1).join(' ');
                        const depMinUTC = timeStrToMinutes(depTimeUTC); const durMin = timeStrToMinutes(eetStr);
                        flights.push({
                            airline: airlineInfo, ident, type, origin, dest, depMinUTC,
                            arrMinUTC: depMinUTC + durMin, durMin, fl, rota, obs, daysOp
                        });
                    }
                } catch(e) {}
            }
        }
        return flights;
    }
  </script>
</body>
</html>