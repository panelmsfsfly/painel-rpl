<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RPL Dispatch 7.0 - Pro System</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">

<style>
    /* --- VARI√ÅVEIS TEMA DISPATCH PROFISSIONAL (DARK) --- */
    :root {
        --bg-body: #0b111e;        
        --bg-card: #151e2d;        
        --bg-input: #0f1724;       
        --text-main: #f1f5f9;      
        --text-muted: #94a3b8;     
        --border-color: #233147;   
        
        --primary: #3b82f6;        
        --accent-purple: #8b5cf6;
        --accent-cyan: #06b6d4;
        --accent-green: #10b981;
        --accent-red: #ef4444;
        --accent-orange: #f59e0b;
        
        --shadow-sm: 0 2px 4px rgba(0,0,0,0.4);
        --shadow-md: 0 8px 16px rgba(0,0,0,0.4);
        --radius: 6px;             
    }

    * { box-sizing: border-box; outline: none; }

    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--bg-body);
        color: var(--text-main);
        padding: 20px;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        font-size: 14px;
    }

    /* --- LAYOUT WRAPPER --- */
    .dashboard-wrapper {
        width: 100%;
        max-width: 1400px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    /* --- ESTILO DE CARDS --- */
    .card-panel {
        background-color: var(--bg-card);
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
        padding: 25px;
        width: 100%;
        border: 1px solid var(--border-color);
        border-top: 3px solid var(--border-color); 
    }

    .card-panel:nth-child(2) { border-top-color: var(--primary); }
    .card-panel:nth-child(3) { border-top-color: var(--accent-purple); }
    .card-panel:nth-child(4) { border-top-color: var(--text-muted); }
    #roster-section { border-top-color: var(--accent-cyan); }
    #hangar-section { border-top-color: var(--accent-orange); }

    /* --- CABE√áALHO --- */
    .header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--bg-card);
        border-radius: var(--radius);
        padding: 20px 30px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
        border-left: 4px solid var(--primary);
    }

    .header-title h1 { margin: 0; font-size: 24px; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; }
    .header-title h1 span { color: var(--primary); }
    .header-title div { font-size: 11px; font-weight: 600; color: var(--accent-cyan); text-transform: uppercase; margin-top: 4px; letter-spacing: 1px; }

    .center-info { text-align: center; }
    .center-main-text { font-weight: 800; font-size: 14px; color: var(--text-main); text-transform: uppercase; letter-spacing: 1.5px; }
    .center-sub-text {
        font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--accent-green); background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.2); padding: 4px 10px; border-radius: 4px; margin-top: 5px; display: inline-block; font-weight: 700;
    }

    .clock-box { text-align: right; }
    .clock-time { font-family: 'JetBrains Mono', monospace; font-size: 28px; font-weight: 700; color: var(--accent-orange); letter-spacing: -1px; text-shadow: 0 0 10px rgba(245, 158, 11, 0.2); }
    .clock-date { font-size: 11px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

    /* --- CONTROLES --- */
    .controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; align-items: end; }
    .control-group { display: flex; flex-direction: column; gap: 8px; }
    .control-label { font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.5px; }

    .sb-input {
        background: var(--bg-input); border: 1px solid var(--border-color); border-radius: var(--radius); padding: 10px 15px;
        font-family: 'Inter', sans-serif; font-weight: 600; color: var(--text-main); width: 100%; transition: all 0.2s;
    }
    .sb-input::placeholder { color: #475569; }
    .sb-input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }

    button {
        cursor: pointer; border: none; padding: 10px 16px; border-radius: var(--radius); font-family: 'Inter', sans-serif;
        font-weight: 700; font-size: 11px; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center;
        gap: 6px; text-transform: uppercase; letter-spacing: 0.5px;
    }
    button:active { transform: translateY(1px); }

    .btn-action { background: var(--primary); color: white; }
    .btn-action:hover { background: #2563eb; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }

    .btn-search { background: var(--accent-purple); color: white; height: 38px; }
    .btn-search:hover { filter: brightness(1.1); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3); }

    .btn-reset { background: var(--border-color); color: var(--text-main); }
    .btn-reset:hover { background: #334155; }

    .btn-logbook { background: var(--bg-input); color: var(--text-main); border: 1px solid var(--border-color); font-size: 10px; padding: 6px 12px; margin-top: 5px; }
    .btn-logbook:hover { border-color: var(--primary); color: var(--primary); background: rgba(59,130,246,0.05); }

    .filter-wrapper { display: flex; gap: 5px; background: var(--bg-input); padding: 4px; border-radius: var(--radius); border: 1px solid var(--border-color); }
    .btn-filter { flex: 1; background: transparent; color: var(--text-muted); padding: 8px; font-size: 10px; }
    .btn-filter:hover { background: rgba(255,255,255,0.05); }
    .btn-filter.active { background: #334155; color: white; }
    .btn-filter[data-cia="LATAM"].active { background: #1B0088; color: white; border:none; }
    .btn-filter[data-cia="GOL"].active { background: #FF5E00; color: white; border:none; }
    .btn-filter[data-cia="AZUL"].active { background: #0055A4; color: white; border:none; }

    .legs-wrapper { display: flex; gap: 5px; }
    .btn-draw { flex: 1; background: var(--bg-input); color: var(--text-main); border: 1px solid var(--border-color); }
    .btn-draw:hover { background: var(--primary); border-color: var(--primary); }

    .btn-sb { background: rgba(239, 68, 68, 0.1); color: var(--accent-red); border: 1px solid var(--accent-red); padding: 6px 10px; font-size: 10px; border-radius: 4px; }
    .btn-sb:hover { background: var(--accent-red); color: white; box-shadow: 0 0 10px rgba(239, 68, 68, 0.4); }

    .btn-schedule { background: rgba(6, 182, 212, 0.1); color: var(--accent-cyan); border: 1px solid var(--accent-cyan); padding: 6px 10px; font-size: 12px; border-radius: 4px; }
    .btn-schedule:hover { background: var(--accent-cyan); color: white; box-shadow: 0 0 10px rgba(6, 182, 212, 0.4); }

    .btn-remove { background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); padding: 6px 10px; border-radius: 4px; font-size: 11px; }
    .btn-remove:hover { background: var(--accent-red); color: white; border-color: var(--accent-red); }

    /* --- TABELAS TIPO LIDO/NAVBLUE --- */
    .flight-table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1000px; }
    
    .flight-table th {
        background: #0f172a; color: var(--text-muted); font-weight: 700; text-transform: uppercase; font-size: 10px;
        padding: 12px 20px; text-align: left; border-bottom: 2px solid var(--border-color); letter-spacing: 1px;
    }
    .flight-table th:first-child { border-top-left-radius: var(--radius); }
    .flight-table th:last-child { border-top-right-radius: var(--radius); }

    .flight-table td {
        padding: 12px 20px; border-bottom: 1px solid var(--border-color); color: var(--text-main);
        vertical-align: middle; font-size: 13px; background: var(--bg-card); transition: background 0.2s;
    }
    .flight-table tr:last-child td { border-bottom: none; }
    .flight-table tr:hover td { background: #1e293b; cursor: default; }

    .col-flight { font-family: 'JetBrains Mono', monospace; font-weight: 800; color: var(--accent-cyan); font-size: 15px; cursor: pointer; text-shadow: 0 0 8px rgba(6,182,212,0.3); }
    .col-flight:hover { text-decoration: underline; color: #fff; }

    .cia-badge { padding: 4px 8px; border-radius: 4px; color: white; font-weight: 800; font-size: 9px; text-transform: uppercase; box-shadow: var(--shadow-sm); letter-spacing: 0.5px; }

    .col-airport { font-weight: 800; font-size: 15px; color: var(--text-main); font-family: 'JetBrains Mono', monospace; }
    .col-days { font-size: 11px; color: var(--text-muted); font-weight: 600; max-width: 120px; line-height: 1.4; }

    /* Time Pills - Estilo Display Digital */
    .time-pill {
        display: inline-flex; flex-direction: column; align-items: center; justify-content: center;
        background: var(--bg-input); color: var(--primary); border: 1px solid var(--border-color);
        padding: 6px 10px; border-radius: 4px; min-width: 75px; text-align:center;
    }
    .time-pill.arr { color: var(--accent-green); border-color: rgba(16, 185, 129, 0.2); }
    .tp-utc { font-size: 10px; opacity: 0.8; font-family: 'JetBrains Mono'; margin-bottom: 2px; color: var(--text-muted); }
    .tp-local { font-size: 16px; font-weight: 800; font-family: 'JetBrains Mono'; line-height: 1; }

    .col-fl { font-family: 'JetBrains Mono'; font-weight: 700; color: var(--accent-purple); background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.2); padding: 4px 8px; border-radius: 4px; font-size: 12px; text-align: center; }
    .col-rota { font-family: 'JetBrains Mono'; font-size: 11px; color: #cbd5e1; max-width: 250px; line-height: 1.4; }

    .roster-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
    .section-title { font-size: 16px; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
    .section-badge { background: var(--accent-cyan); color: #0b111e; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 800; }

    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
    .stat-card { background: var(--bg-input); border: 1px solid var(--border-color); border-radius: var(--radius); padding: 20px; display: flex; align-items: center; gap: 15px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
    .stat-icon { width: 45px; height: 45px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; background: var(--bg-card); border: 1px solid var(--border-color); }
    .stat-info h4 { margin: 0; font-size: 10px; color: var(--text-muted); text-transform: uppercase; font-weight: 700; letter-spacing: 1px;}
    .stat-info p { margin: 5px 0 0 0; font-size: 24px; font-weight: 800; color: var(--text-main); font-family: 'JetBrains Mono'; }

    .tutorial-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
    .tut-card { background: var(--bg-card); padding: 20px; border-radius: var(--radius); border: 1px solid var(--border-color); border-left: 3px solid var(--text-muted); }
    .tut-card h4 { margin: 0 0 10px 0; color: var(--text-main); font-size: 13px; font-weight: 700; text-transform: uppercase;}
    .tut-card p { margin: 0; font-size: 12px; color: var(--text-muted); line-height: 1.6; }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .modal-content { background: var(--bg-card); padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; border: 1px solid var(--border-color); box-shadow: 0 20px 40px rgba(0,0,0,0.5); animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
    .modal-title { font-size: 20px; font-weight: 800; color: var(--text-main); font-family: 'JetBrains Mono';}
    .close-modal { font-size: 24px; color: var(--text-muted); background: none; padding: 0; border: none; cursor: pointer; }
    .close-modal:hover { color: var(--accent-red); }
    
    .detail-row { display: flex; padding: 12px 0; border-bottom: 1px dashed var(--border-color); }
    .detail-label { width: 140px; font-weight: 700; color: var(--text-muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
    .detail-val { flex: 1; font-family: 'JetBrains Mono'; font-weight: 700; color: var(--accent-cyan); }

    .site-footer { text-align: center; padding: 20px 0; margin-top: 10px; color: #475569; font-size: 11px; font-weight: 600; border-top: 1px dashed var(--border-color); letter-spacing: 1px; text-transform: uppercase; }

    @media (max-width: 900px) {
        .header-container { flex-direction: column; gap: 15px; text-align: center; border-left: none; border-top: 4px solid var(--primary); }
        .controls-grid { grid-template-columns: 1fr; }
        .clock-time { font-size: 24px; }
        .flight-table-container { overflow-x: auto; }
    }
</style>
</head>
<body>

<div class="dashboard-wrapper">

    <div class="header-container">
        <div class="header-title">
            <h1>RPL Dispatch <span>7.0</span></h1>
            <div>Simulador de Voo Dom√©stico</div>
        </div>
        
        <div class="center-info">
            <div class="center-main-text">Malha A√©rea Real Brasil</div>
            <div class="center-sub-text" id="validity-box">VALIDADE: ---</div>
        </div>

        <div class="clock-box">
            <div class="clock-time" id="brt-clock">00:00:00</div>
            <div class="clock-date" id="brt-date">---</div>
            <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 5px;">
                <button class="btn-logbook" onclick="toggleHangar()">‚úàÔ∏è HANGAR</button>
                <button class="btn-logbook" onclick="toggleLogbook()">üìñ LOGBOOK</button>
            </div>
        </div>
    </div>

    <div id="hangar-section" class="card-panel" style="display: none;">
        <div class="roster-header">
            <div class="section-title">‚úàÔ∏è Meu Hangar (Frota)</div>
            <div style="font-size: 12px; color:var(--text-muted);">Gerencie onde suas aeronaves est√£o estacionadas</div>
        </div>
        
        <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: flex-end; flex-wrap: wrap;">
            <div class="control-group">
                <label class="control-label">Cia A√©rea</label>
                <input type="text" id="hangar-cia" class="sb-input" placeholder="Ex: GOL" style="width: 150px; text-transform: uppercase;">
            </div>
            <div class="control-group">
                <label class="control-label">Tipo (Aeronave)</label>
                <input type="text" id="hangar-type" class="sb-input" placeholder="Ex: B738" style="width: 120px; text-transform: uppercase;">
            </div>
            <div class="control-group">
                <label class="control-label">Local Atual (ICAO)</label>
                <input type="text" id="hangar-loc" class="sb-input" placeholder="Ex: SBSP" style="width: 150px; text-transform: uppercase;">
            </div>
            <div class="control-group">
                <button class="btn-action" onclick="addAircraftToHangar()" style="height: 38px; border-radius: 4px;">‚ûï ADICIONAR</button>
            </div>
        </div>

        <div style="overflow-x:auto; border-radius:6px; border:1px solid var(--border-color);">
            <table class="flight-table">
                <thead>
                    <tr>
                        <th>Cia A√©rea</th>
                        <th>Tipo</th>
                        <th>Localiza√ß√£o (ICAO)</th>
                        <th style="text-align:center;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="hangar-body"></tbody>
            </table>
            <div id="hangar-empty" style="padding:30px; text-align:center; color:var(--text-muted); display:block; background: var(--bg-card);">
                Seu hangar est√° vazio. Adicione uma aeronave acima ou pelo Logbook.
            </div>
        </div>
    </div>

    <div class="card-panel">
        <div style="font-weight:800; text-transform: uppercase; margin-bottom: 15px; color:var(--text-main); font-size:13px; display: flex; align-items: center; gap: 8px;">
            ‚öôÔ∏è Setup e Gerador de Escalas
        </div>
        <div class="controls-grid">
            
            <div class="control-group">
                <label class="control-label">SimBrief ID</label>
                <input type="text" id="sb-id" class="sb-input" placeholder="Ex: 123456" oninput="saveSBID()">
            </div>

            <div class="control-group">
                <label class="control-label">Companhia A√©rea</label>
                <div class="filter-wrapper">
                    <button class="btn-filter active" onclick="setFilter('todas', this)">Todas</button>
                    <button class="btn-filter" data-cia="LATAM" onclick="setFilter('LATAM', this)">Latam</button>
                    <button class="btn-filter" data-cia="GOL" onclick="setFilter('GOL', this)">Gol</button>
                    <button class="btn-filter" data-cia="AZUL" onclick="setFilter('AZUL', this)">Azul</button>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">Gerar Escala (Hor√°rio Real)</label>
                <div class="legs-wrapper">
                    <button class="btn-draw" onclick="generateRealTimeChain(1)">1</button>
                    <button class="btn-draw" onclick="generateRealTimeChain(2)">2</button>
                    <button class="btn-draw" onclick="generateRealTimeChain(3)">3</button>
                    <button class="btn-draw" onclick="generateRealTimeChain(4)">4</button>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">Buscar N¬∫ Voo</label>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="search-input" class="sb-input" placeholder="Ex: 1234" onkeydown="if(event.key==='Enter') manualSearch()">
                    <button class="btn-search" style="border-radius: 4px;" onclick="manualSearch()">BUSCAR</button>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">&nbsp;</label>
                <button class="btn-reset" style="height:38px; border-radius:4px;" onclick="resetPanel()">Limpar Filtros</button>
            </div>

        </div>
    </div>

    <div class="card-panel">
        <div style="font-weight:800; text-transform: uppercase; color:var(--text-main); font-size:13px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
            üìç Pesquisa Livre de Aeroportos e Rotas
        </div>
        <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end;">
            
            <div class="control-group" style="flex: 1; min-width: 200px;">
                <label class="control-label">Aeroporto de Origem</label>
                <input type="text" id="airport-search" class="sb-input" placeholder="Ex: SBGR" onkeydown="if(event.key==='Enter') searchFlights()">
            </div>

            <div class="control-group" style="flex: 1; min-width: 200px;">
                <label class="control-label">Aeroporto de Destino</label>
                <input type="text" id="destination-search" class="sb-input" placeholder="Opcional (Ex: SBSP)" onkeydown="if(event.key==='Enter') searchFlights()">
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn-action" style="background:var(--accent-purple); height:38px; border-radius:4px; font-size: 12px; width: 100%;" onclick="searchFlights()">üîç BUSCAR VOOS</button>
            </div>

        </div>
    </div>

    <div class="card-panel" style="padding:0; overflow:hidden;">
        <div style="padding: 20px 25px; border-bottom:1px solid var(--border-color); background: #0f1724;">
            <div style="font-weight:800; text-transform: uppercase; color:var(--text-main); font-size:14px;">Quadro de Voos Dispon√≠veis</div>
        </div>
        <div style="overflow-x:auto;">
            <table class="flight-table">
                <thead>
                    <tr>
                        <th style="text-align: center;">A√ß√µes</th> 
                        <th>Voo</th>
                        <th>Cia</th>
                        <th>Aeronave</th>
                        <th>Dias</th> 
                        <th>Origem</th>
                        <th>Hor√°rios (Z / BRT)</th>
                        <th>Destino</th>
                        <th>Chegada (Z / BRT)</th>
                        <th style="text-align: center;">FL</th>
                        <th>Rota</th>
                    </tr>
                </thead>
                <tbody id="board-content"></tbody>
            </table>
            <div id="empty-msg" style="padding:50px; text-align:center; color:var(--text-muted); font-style:italic;">
                Aguardando busca de voos...
            </div>
        </div>
    </div>

    <div id="roster-section" class="card-panel" style="padding:0; overflow:hidden;">
        <div class="roster-header" style="margin:0; padding: 20px 25px; border-bottom:1px solid var(--border-color); background: #0f1724;">
            <div class="section-title">üìÖ Minha Escala (Roster) <span class="section-badge" id="roster-badge">0</span></div>
        </div>
        
        <div style="overflow-x:auto;">
            <table class="flight-table">
                <thead>
                    <tr>
                        <th style="text-align: center;">Gerenciar</th> 
                        <th>Voo</th>
                        <th>Cia</th>
                        <th>Aeronave</th>
                        <th>Dias</th> 
                        <th>Origem</th>
                        <th>Partida (Z / BRT)</th>
                        <th>Destino</th>
                        <th>Chegada (Z / BRT)</th>
                        <th style="text-align: center;">FL</th>
                        <th>Rota</th>
                    </tr>
                </thead>
                <tbody id="roster-body">
                </tbody>
            </table>
            <div id="roster-empty" style="padding:40px; text-align:center; color:var(--text-muted); display:block; background: var(--bg-card);">
                Nenhum voo na escala. Adicione no painel acima.
            </div>
        </div>
    </div>

    <div id="logbook-section" class="card-panel" style="display: none;">
        <div class="roster-header">
            <div class="section-title">üìñ Logbook do Piloto</div>
            <div style="display: flex; gap: 8px;">
                <input type="file" id="backup-file-input" style="display: none;" onchange="restoreLogbook(event)">
                <button class="btn-reset" onclick="backupLogbook()">‚¨áÔ∏è Backup</button>
                <button class="btn-reset" onclick="document.getElementById('backup-file-input').click()">‚¨ÜÔ∏è Restaurar</button>
                <button class="btn-remove" onclick="clearLogbook()">Limpar Tudo</button>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="color: var(--primary);">‚úàÔ∏è</div>
                <div class="stat-info">
                    <h4>Total de Voos</h4>
                    <p id="stats-count">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="color: var(--accent-green);">‚è±Ô∏è</div>
                <div class="stat-info">
                    <h4>Horas Voadas</h4>
                    <p id="stats-hours">00h 00m</p>
                </div>
            </div>
        </div>

        <div style="overflow-x:auto; border-radius:6px; border:1px solid var(--border-color);">
            <table class="flight-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Voo</th>
                        <th>Origem</th>
                        <th>Destino</th>
                        <th>Tempo</th>
                        <th>Aeronave</th>
                        <th style="text-align:center;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="logbook-body"></tbody>
            </table>
            <div id="logbook-empty" style="padding:30px; text-align:center; color:var(--text-muted); display:none; background: var(--bg-card);">
                Nenhum registro de voo ainda.
            </div>
        </div>
    </div>

    <div class="tutorial-grid">
        <div class="tut-card">
            <h4>üîé Busca e Escalas</h4>
            <p>Busque rotas espec√≠ficas ou use o <strong>Gerador de Escala</strong> para montar a sua jornada do dia com c√°lculos autom√°ticos de 45m de turnaround (solo).</p>
        </div>
        <div class="tut-card">
            <h4>üìÑ Despacho SimBrief</h4>
            <p>Com um clique (<strong>Simbrief ‚Üó</strong>), envie aeronave, rota, indicativo e hor√°rios ZULU exatos para o SimBrief. O voo √© registrado no Logbook automaticamente!</p>
        </div>
        <div class="tut-card">
            <h4>üìñ Logbook Inteligente</h4>
            <p>Acompanhe suas horas totais. Ao terminar um voo, clique em <strong>üÖøÔ∏è HANGAR</strong>: o sistema l√™ seu callsign e estaciona o avi√£o no aeroporto de chegada.</p>
        </div>
        <div class="tut-card">
            <h4>‚úàÔ∏è Meu Hangar</h4>
            <p>Gerencie onde sua frota dormiu. Clique em <strong>üõ´ VOAR DAQUI</strong> e o painel preenche a origem e filtra a Cia A√©rea automaticamente para o seu pr√≥ximo voo.</p>
        </div>
    </div>

    <div class="site-footer">
        DADOS TABULADOS: DECEA PARA USO EXCLUSIVO EM SIMULADORES CASEIROS
    </div>

</div> 

<div id="flight-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">
                <span id="modal-cia-badge" class="cia-badge" style="font-size:14px;">CIA</span>
                <span id="modal-flight-num" style="margin-left:10px;">VOO 1234</span>
            </div>
            <button class="close-modal" aria-label="Fechar" onclick="closeModal()">√ó</button>
        </div>
        
        <div id="modal-body">
            <div class="detail-row"><span class="detail-label">Aeronave</span> <span class="detail-val" id="md-acft"></span></div>
             <div class="detail-row"><span class="detail-label">Rota Completa</span> <span class="detail-val" id="md-route" style="font-size:12px;"></span></div>
             <div class="detail-row"><span class="detail-label">Trecho</span> <span class="detail-val" id="md-deparr"></span></div>
             <div class="detail-row"><span class="detail-label">Tempo Estimado</span> <span class="detail-val" id="md-eet"></span></div>
             <div class="detail-row"><span class="detail-label">N√≠vel (FL)</span> <span class="detail-val" id="md-fl"></span></div>
             <div class="detail-row"><span class="detail-label">Dias de Opera√ß√£o</span> <span class="detail-val" id="md-days" style="color:var(--text-main);"></span></div>
             <div class="detail-row" style="border-bottom:none;"><span class="detail-label">Observa√ß√µes</span> <span class="detail-val" id="md-obs" style="color:var(--text-muted); font-size:11px;"></span></div>
        </div>
    </div>
</div>

<script>
    const USE_REAL_TIME_DATE = true; 
    const SIMULATE_DATE_FIXED = "2026-02-07"; 
    const TURNAROUND_MINUTES = 45; 

    const airlineConfig = [
        { id: 'LATAM', name: 'LATAM', file: 'Cia_TAM_CS.txt', color: '#1B0088' },
        { id: 'GOL', name: 'GOL', file: 'Cia_GLO_CS.txt', color: '#FF5E00' },
        { id: 'AZUL', name: 'AZUL', file: 'Cia_AZU_CS.txt', color: '#0055A4' }
    ];

    let allFlightsDB = [];
    let currentFilter = 'todas';
    let displayedFlights = [];
    let validityUpdated = false;

    function getSafeStorage(key) {
        try {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        } catch (e) {
            return [];
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        const savedID = localStorage.getItem("simbrief_id");
        if (savedID) document.getElementById("sb-id").value = savedID;
        renderHangar();
        renderLogbook();
        renderRoster();
        loadAllFiles(); 
    });

    function saveSBID() {
        localStorage.setItem("simbrief_id", document.getElementById("sb-id").value);
    }

    function openSimBriefWithData(flight) {
        const sbID = document.getElementById("sb-id").value;
        if (!sbID) {
            alert("Preencha o ID do SimBrief no painel de controles.");
            document.getElementById("sb-id").focus();
            return;
        }

        saveToLogbook(flight);

        const airlineCode = flight.ident.match(/^[A-Z]+/)[0];
        const fltNumber = flight.ident.match(/\d+/)[0];
        let cleanType = flight.type.split('/')[0]; 
        const routeEncoded = encodeURIComponent(flight.rota);

        let hours = Math.floor(flight.depMinUTC / 60);
        let minutes = flight.depMinUTC % 60;
        if (hours >= 24) hours = hours % 24;

        // Ajusta a data para o SimBrief usando a convers√£o de fuso hor√°rio BRT correto
        const dateObj = getSimulationDate(); 
        if (flight.offsetDay) {
            dateObj.setDate(dateObj.getDate() + flight.offsetDay);
        }
        
        let depMinBRT = flight.depMinUTC - 180;
        if (depMinBRT < 0) depMinBRT += 1440;
        dateObj.setHours(Math.floor(depMinBRT / 60), depMinBRT % 60, 0, 0);

        const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
        const day = String(dateObj.getUTCDate()).padStart(2, '0');
        const month = monthNames[dateObj.getUTCMonth()];
        const year = String(dateObj.getUTCFullYear()).slice(-2); 
        const sbDate = `${day}${month}${year}`;

        const url = `https://www.simbrief.com/system/dispatch.php?userid=${sbID}&airline=${airlineCode}&fltnum=${fltNumber}&orig=${flight.origin}&dest=${flight.dest}&route=${routeEncoded}&type=${cleanType}&date=${sbDate}&deph=${hours}&depm=${minutes}&fl=${flight.fl}`;
        
        window.open(url, '_blank');
    }

    function openSimBriefFromIndex(index) {
        const flight = displayedFlights[index];
        if (!flight) return;
        openSimBriefWithData(flight);
    }

    function resetPanel() {
        document.getElementById('board-content').innerHTML = '';
        document.getElementById('empty-msg').style.display = 'block';
        document.getElementById('empty-msg').innerText = "Painel limpo. Selecione os filtros acima.";
        document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
        
        document.getElementById('search-input').value = '';
        document.getElementById('airport-search').value = '';
        document.getElementById('destination-search').value = '';
        
        displayedFlights = [];
    }

    function setFilter(filterName, btnElement) {
        document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');
        currentFilter = filterName;
    }

    // --- NOVA LOGICA DE BUSCA: HOR√ÅRIO LOCAL (BRT) ---
    function getUpcomingFlights(orig, dest = null, ciaFilter = 'todas', maxHours = 48) {
        const now = getSimulationDate();
        const currentBRTMinutes = (now.getHours() * 60) + now.getMinutes();
        const currentLocalDay = now.getDay();
        const rplCurrentLocalDayIdx = currentLocalDay === 0 ? 6 : currentLocalDay - 1; 
        
        let results = [];

        allFlightsDB.forEach(f => {
            if (orig && f.origin !== orig) return;
            if (dest && f.dest !== dest) return;
            if (ciaFilter !== 'todas' && f.airline.name !== ciaFilter) return;

            let depMinBRT = f.depMinUTC - 180;
            if (depMinBRT < 0) depMinBRT += 1440;

            // Checa Hoje, Amanh√£ e Depois
            for (let offset = 0; offset <= 2; offset++) {
                const checkLocalDayIdx = (rplCurrentLocalDayIdx + offset) % 7;
                
                // Converte o Dia Local de volta para o Dia UTC que est√° no arquivo
                let utcDayIdx = checkLocalDayIdx;
                if (f.depMinUTC < 180) { 
                    utcDayIdx = (checkLocalDayIdx + 1) % 7;
                }

                if (f.daysOp.charAt(utcDayIdx) !== '0' && f.daysOp.charAt(utcDayIdx) !== ' ') {
                    let minsFromNow = (offset * 1440) + depMinBRT - currentBRTMinutes;
                    
                    if (minsFromNow >= 0 && minsFromNow <= (maxHours * 60)) { 
                        results.push({ ...f, offsetDay: offset, sortMins: minsFromNow });
                    }
                }
            }
        });

        results.sort((a, b) => a.sortMins - b.sortMins);
        return results;
    }

    function manualSearch() {
        const rawInput = document.getElementById('search-input').value;
        const input = rawInput ? rawInput.toUpperCase().replace(/\s+/g, '') : "";

        if (input.length < 3) { alert("Digite pelo menos 3 caracteres."); return; }
        if(allFlightsDB.length === 0) { alert("Aguarde o carregamento."); return; }

        const now = getSimulationDate();
        const currentBRTMinutes = (now.getHours() * 60) + now.getMinutes();
        const currentLocalDay = now.getDay();
        const rplCurrentLocalDayIdx = currentLocalDay === 0 ? 6 : currentLocalDay - 1;

        let matches = [];
        allFlightsDB.forEach(f => {
            if (f.ident.includes(input)) {
                let depMinBRT = f.depMinUTC - 180;
                if (depMinBRT < 0) depMinBRT += 1440;

                for (let offset = 0; offset <= 2; offset++) {
                    const checkLocalDayIdx = (rplCurrentLocalDayIdx + offset) % 7;
                    let utcDayIdx = checkLocalDayIdx;
                    if (f.depMinUTC < 180) utcDayIdx = (checkLocalDayIdx + 1) % 7;

                    if (f.daysOp.charAt(utcDayIdx) !== '0' && f.daysOp.charAt(utcDayIdx) !== ' ') {
                        let minsFromNow = (offset * 1440) + depMinBRT - currentBRTMinutes;
                        
                        if(minsFromNow > -1440 && minsFromNow <= 2880) { // Mostra voos que j√° passaram hoje tamb√©m
                            matches.push({ ...f, offsetDay: offset, sortMins: minsFromNow });
                        }
                    }
                }
            }
        });

        if (matches.length === 0) { alert("Voo n√£o encontrado."); return; }

        matches.sort((a,b) => a.sortMins - b.sortMins);
        displayedFlights = matches.map(f => enrichFlightData(f));
        renderRows(displayedFlights);
        document.getElementById('empty-msg').style.display = 'none';
    }

    function searchFlights() {
        const rawOrig = document.getElementById('airport-search').value;
        const orig = rawOrig ? rawOrig.toUpperCase().trim() : "";
        const rawDest = document.getElementById('destination-search').value;
        const dest = rawDest ? rawDest.toUpperCase().trim() : "";
        
        if (orig.length < 3) { 
            alert("Preencha pelo menos 3 caracteres na Origem (Ex: SBGR)."); 
            return; 
        }
        if(allFlightsDB.length === 0) { alert("Aguarde o carregamento da malha."); return; }

        const matches = getUpcomingFlights(orig, dest.length >= 3 ? dest : null, currentFilter, 48);

        if (matches.length === 0) {
            if (dest.length >= 3) {
                alert(`Nenhum voo direto encontrado de ${orig} para ${dest} nas pr√≥ximas 48 horas.`);
            } else {
                alert(`Nenhuma partida encontrada saindo de ${orig} nas pr√≥ximas 48 horas.`);
            }
            return;
        }

        displayedFlights = matches.map(f => enrichFlightData(f));
        renderRows(displayedFlights);
        document.getElementById('empty-msg').style.display = 'none';
    }

    function generateRealTimeChain(chainLength) {
        const orig = document.getElementById('airport-search').value.toUpperCase().trim();
        
        let candidates = getUpcomingFlights(orig.length >= 3 ? orig : null, null, currentFilter, 24);
        if (candidates.length === 0) { alert("Sem voos dispon√≠veis nas pr√≥ximas horas."); return; }
        
        let seedCandidates = candidates.filter(f => f.sortMins >= 30 && f.sortMins <= 180);
        if (seedCandidates.length === 0) seedCandidates = candidates;

        const seed = seedCandidates[Math.floor(Math.random() * Math.min(15, seedCandidates.length))];
        let chain = [enrichFlightData(seed)];

        for (let i = 1; i < chainLength; i++) {
            const prev = chain[i-1];
            
            const prevArrMinsFromNow = prev.sortMins + prev.durMin;
            const minNextDepMinsFromNow = prevArrMinsFromNow + TURNAROUND_MINUTES;
            
            let nextLegs = getUpcomingFlights(prev.dest, null, prev.airline.name, 48);
            nextLegs = nextLegs.filter(f => f.sortMins >= minNextDepMinsFromNow);
            
            if (nextLegs.length > 0) {
                chain.push(enrichFlightData(nextLegs[0]));
            } else break;
        }
        
        displayedFlights = chain;
        renderRows(chain);
        document.getElementById('empty-msg').style.display = 'none';
    }

    function enrichFlightData(flight) {
        const toBRT = (utc) => { let b = utc - 180; if(b<0) b+=1440; if(b>=1440) b-=1440; return b; };
        const depMinBRT = toBRT(flight.depMinUTC);
        const arrMinBRT = toBRT(flight.arrMinUTC);
        let arrUtc = flight.arrMinUTC >= 1440 ? flight.arrMinUTC - 1440 : flight.arrMinUTC;
        let nextDay = arrMinBRT < depMinBRT;
        
        let depPrefix = "";
        if (flight.offsetDay === 1) {
            depPrefix = `<span style="color:var(--accent-orange); font-size:9px; display:block; margin-bottom:2px; font-weight:800; letter-spacing:1px;">AMANH√É</span>`;
        } else if (flight.offsetDay > 1) {
            depPrefix = `<span style="color:var(--accent-orange); font-size:9px; display:block; margin-bottom:2px; font-weight:800; letter-spacing:1px;">+${flight.offsetDay} DIAS</span>`;
        }

        return {
            ...flight,
            depDisplay: minutesToTimeStr(depMinBRT),
            arrDisplay: minutesToTimeStr(arrMinBRT),
            depDisplayUTC: minutesToTimeStr(flight.depMinUTC),
            arrDisplayUTC: minutesToTimeStr(arrUtc),
            isNextDay: nextDay,
            depPrefix: depPrefix
        };
    }

    function timeStrToMinutes(str) {
        return (parseInt(str.substring(0,2))*60) + parseInt(str.substring(2,4));
    }

    function minutesToTimeStr(min) {
        let h = Math.floor(min/60)%24; let m = Math.floor(min%60);
        return String(h).padStart(2,'0') + ":" + String(m).padStart(2,'0');
    }

    // --- CORRE√á√ÉO DE DIAS PARA HOR√ÅRIO LOCAL ---
    function formatDaysLocal(daysStr, depMinUTC) {
        if (!daysStr) return "N/A";
        const labels = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'];
        let localDaysActive = [false, false, false, false, false, false, false];
        
        let shift = depMinUTC < 180 ? -1 : 0;

        for (let i = 0; i < daysStr.length; i++) {
            if (daysStr[i] !== ' ' && daysStr[i] !== '0') {
                let localDayIdx = (i + shift + 7) % 7;
                localDaysActive[localDayIdx] = true;
            }
        }
        
        let active = [];
        for (let i = 0; i < 7; i++) {
            if (localDaysActive[i]) active.push(labels[i]);
        }
        return active.length > 0 ? active.join(', ') : "N√£o especificado";
    }

    function scheduleFlight(index) {
        const flight = displayedFlights[index];
        if (!flight) return;

        let roster = getSafeStorage('myPilotRoster');
        roster.push({ id: Date.now(), flightData: flight });
        roster.sort((a, b) => (a.flightData.sortMins || 0) - (b.flightData.sortMins || 0));
        
        localStorage.setItem('myPilotRoster', JSON.stringify(roster));
        renderRoster();
        document.getElementById('roster-section').scrollIntoView({behavior: 'smooth'});
    }

    function renderRows(flights) {
        const tbody = document.getElementById('board-content');
        tbody.innerHTML = '';
        flights.forEach((f, index) => {
            const tr = document.createElement('tr');
            
            const sbButton = `<button class="btn-sb" title="Abrir no SimBrief" aria-label="Abrir voo no SimBrief" onclick="openSimBriefFromIndex(${index})">Simbrief ‚Üó</button>`;
            const scheduleButton = `<button class="btn-schedule" title="Agendar voo na escala" aria-label="Agendar voo" onclick="scheduleFlight(${index})">‚ûï</button>`;
            
            const arrHtml = f.isNextDay ? `<span style="color:var(--accent-orange); font-size:9px; display:block; margin-top:2px;">(+1)</span>` : ``;
            const depCell = `<div class="time-pill">${f.depPrefix || ''}<div class="tp-utc">${f.depDisplayUTC}z</div><div class="tp-local">${f.depDisplay}</div></div>`;
            const arrCell = `<div class="time-pill arr"><div class="tp-utc">${f.arrDisplayUTC}z</div><div class="tp-local">${f.arrDisplay}</div>${arrHtml}</div>`;
            const acftType = f.type.split('/')[0];

            tr.innerHTML = `
                <td><div style="display:flex; gap:5px; justify-content:center;">${sbButton}${scheduleButton}</div></td>
                <td class="col-flight" onclick="showFlightDetails(${index})">${f.ident}</td>
                <td><span class="cia-badge" style="background-color: ${f.airline.color}">${f.airline.name}</span></td>
                <td style="font-weight:800; font-family:'JetBrains Mono';">${acftType}</td>
                <td class="col-days">${formatDaysLocal(f.daysOp, f.depMinUTC)}</td>
                <td class="col-airport">${f.origin}</td>
                <td style="text-align:center;">${depCell}</td>
                <td class="col-airport">${f.dest}</td>
                <td style="text-align:center;">${arrCell}</td>
                <td class="col-fl">${f.fl}</td>
                <td class="col-rota">${f.rota}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderRoster() {
        const roster = getSafeStorage('myPilotRoster');
        const tbody = document.getElementById('roster-body');
        const emptyMsg = document.getElementById('roster-empty');
        
        document.getElementById('roster-badge').innerText = roster.length;

        tbody.innerHTML = '';
        if (roster.length === 0) { emptyMsg.style.display = 'block'; return; }
        else { emptyMsg.style.display = 'none'; }

        roster.forEach(entry => {
            const f = entry.flightData;
            const tr = document.createElement('tr');
            
            const sbButton = `<button class="btn-sb" title="Abrir no SimBrief" aria-label="Abrir voo no SimBrief" onclick="dispatchRosterFlight(${entry.id})">Simbrief ‚Üó</button>`;
            const removeButton = `<button class="btn-remove" title="Remover da Escala" aria-label="Remover voo da escala" onclick="deleteRosterEntry(${entry.id})">‚úï</button>`;

            const arrHtml = f.isNextDay ? `<span style="color:var(--accent-orange); font-size:9px; display:block; margin-top:2px;">(+1)</span>` : ``;
            const depCell = `<div class="time-pill">${f.depPrefix || ''}<div class="tp-utc">${f.depDisplayUTC}z</div><div class="tp-local">${f.depDisplay}</div></div>`;
            const arrCell = `<div class="time-pill arr"><div class="tp-utc">${f.arrDisplayUTC}z</div><div class="tp-local">${f.arrDisplay}</div>${arrHtml}</div>`;
            const acftType = f.type.split('/')[0];

            tr.innerHTML = `
                <td><div style="display:flex; gap:5px; justify-content:center;">${sbButton}${removeButton}</div></td>
                <td class="col-flight" onclick="showRosterFlightDetails(${entry.id})">${f.ident}</td>
                <td><span class="cia-badge" style="background-color: ${f.airline.color}">${f.airline.name}</span></td>
                <td style="font-weight:800; font-family:'JetBrains Mono';">${acftType}</td>
                <td class="col-days">${formatDaysLocal(f.daysOp, f.depMinUTC)}</td>
                <td class="col-airport">${f.origin}</td>
                <td style="text-align:center;">${depCell}</td>
                <td class="col-airport">${f.dest}</td>
                <td style="text-align:center;">${arrCell}</td>
                <td class="col-fl">${f.fl}</td>
                <td class="col-rota">${f.rota}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function dispatchRosterFlight(id) {
        const roster = getSafeStorage('myPilotRoster');
        const entry = roster.find(e => e.id === id);
        if (entry) openSimBriefWithData(entry.flightData);
    }

    function deleteRosterEntry(id) {
        if(!confirm("Remover da escala?")) return;
        let roster = getSafeStorage('myPilotRoster');
        roster = roster.filter(e => e.id !== id);
        localStorage.setItem('myPilotRoster', JSON.stringify(roster));
        renderRoster();
    }

    /* --- LOGICA DO HANGAR --- */
    function toggleHangar() {
        const div = document.getElementById('hangar-section');
        if (div.style.display === 'none') {
            div.style.display = 'block';
            renderHangar();
            div.scrollIntoView({ behavior: 'smooth' });
        } else {
            div.style.display = 'none';
        }
    }

    function renderHangar() {
        const hangar = getSafeStorage('myPilotHangar');
        const tbody = document.getElementById('hangar-body');
        const emptyMsg = document.getElementById('hangar-empty');
        
        tbody.innerHTML = '';
        if (hangar.length === 0) { emptyMsg.style.display = 'block'; return; }
        else { emptyMsg.style.display = 'none'; }

        hangar.forEach(acft => {
            const displayCia = acft.cia || acft.reg || 'N/A';
            const badgeColor = displayCia === 'LATAM' ? '#1B0088' : (displayCia === 'GOL' ? '#FF5E00' : (displayCia === 'AZUL' ? '#0055A4' : 'var(--border-color)'));

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span class="cia-badge" style="background-color: ${badgeColor}; padding: 6px 12px; font-size: 11px;">${displayCia}</span></td>
                <td style="font-weight:800; font-size: 15px; font-family: 'JetBrains Mono'; color:var(--text-main);">${acft.type}</td>
                <td class="col-airport" style="color:var(--accent-cyan);">${acft.loc}</td>
                <td>
                    <div style="display:flex; gap:5px; justify-content:center;">
                        <button class="btn-schedule" title="Procurar voos saindo daqui" onclick="flyFromHangar('${acft.loc}', '${displayCia}')">üõ´ VOAR DAQUI</button>
                        <button class="btn-remove" title="Remover do Hangar" onclick="removeAircraftFromHangar(${acft.id})">üóëÔ∏è</button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function addAircraftToHangar() {
        const cia = document.getElementById('hangar-cia').value.toUpperCase().trim();
        const type = document.getElementById('hangar-type').value.toUpperCase().trim();
        const loc = document.getElementById('hangar-loc').value.toUpperCase().trim();

        if(!cia || !type || !loc) { alert("Preencha Cia, Tipo e Localiza√ß√£o (ICAO)."); return; }
        if(loc.length !== 4) { alert("O ICAO deve ter exatamente 4 letras (Ex: SBGR)."); return; }

        let hangar = getSafeStorage('myPilotHangar');
        hangar.push({ id: Date.now(), cia, type, loc });
        localStorage.setItem('myPilotHangar', JSON.stringify(hangar));
        
        document.getElementById('hangar-cia').value = '';
        document.getElementById('hangar-type').value = '';
        document.getElementById('hangar-loc').value = '';
        
        renderHangar();
    }

    function removeAircraftFromHangar(id) {
        if(!confirm("Tem certeza que deseja remover esta aeronave do hangar?")) return;
        let hangar = getSafeStorage('myPilotHangar');
        hangar = hangar.filter(a => a.id !== id);
        localStorage.setItem('myPilotHangar', JSON.stringify(hangar));
        renderHangar();
    }

    function flyFromHangar(loc, cia) {
        document.getElementById('airport-search').value = loc;
        document.getElementById('destination-search').value = '';
        
        const btn = document.querySelector(`.btn-filter[data-cia="${cia}"]`);
        if (btn) {
            setFilter(cia, btn);
        } else {
            const allBtn = document.querySelector('.btn-filter');
            setFilter('todas', allBtn);
        }

        searchFlights();
        document.getElementById('airport-search').scrollIntoView({behavior: 'smooth'});
    }

    function parkFromLogbook(callsign, type, arrLoc) {
        let cia = "";
        if(callsign.startsWith("TAM") || callsign.startsWith("LTG")) cia = "LATAM";
        else if(callsign.startsWith("GLO")) cia = "GOL";
        else if(callsign.startsWith("AZU")) cia = "AZUL";
        else {
            const match = callsign.match(/^[A-Z]+/);
            cia = match ? match[0] : "DESCONHECIDA";
        }

        let hangar = getSafeStorage('myPilotHangar');
        hangar.push({ id: Date.now(), cia: cia, type: type.toUpperCase(), loc: arrLoc.toUpperCase() });
        localStorage.setItem('myPilotHangar', JSON.stringify(hangar));
        
        alert(`‚úàÔ∏è Aeronave da ${cia} (${type}) estacionada com sucesso em ${arrLoc}!`);
        renderHangar();
    }

    /* --- LOGICA DO LOGBOOK --- */
    function saveToLogbook(flight) {
        let logbook = getSafeStorage('myPilotLogbook');
        const now = new Date();
        const dateStr = now.toLocaleDateString('pt-BR');
        
        const durHours = Math.floor(flight.durMin / 60);
        const durMins = flight.durMin % 60;
        const durStr = String(durHours).padStart(2,'0') + ":" + String(durMins).padStart(2,'0');

        logbook.unshift({
            id: Date.now(),
            date: dateStr,
            callsign: flight.ident,
            dep: flight.origin,
            arr: flight.dest,
            time: durStr,
            acft: flight.type.split('/')[0]
        });
        localStorage.setItem('myPilotLogbook', JSON.stringify(logbook));
        renderLogbook();
    }

    function renderLogbook() {
        const logbook = getSafeStorage('myPilotLogbook');
        const tbody = document.getElementById('logbook-body');
        const emptyMsg = document.getElementById('logbook-empty');
        
        let totalMinutes = 0;
        logbook.forEach(e => {
            const parts = e.time.split(':');
            totalMinutes += (parseInt(parts[0]) * 60) + parseInt(parts[1]);
        });
        const totalH = Math.floor(totalMinutes / 60);
        const totalM = totalMinutes % 60;
        
        document.getElementById('stats-count').innerText = logbook.length;
        document.getElementById('stats-hours').innerText = `${String(totalH).padStart(2,'0')}h ${String(totalM).padStart(2,'0')}m`;

        tbody.innerHTML = '';
        if (logbook.length === 0) { emptyMsg.style.display = 'block'; return; }
        else { emptyMsg.style.display = 'none'; }

        logbook.forEach(entry => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="color:var(--text-muted);">${entry.date}</td>
                <td style="font-weight:800; color:var(--accent-cyan); font-family:'JetBrains Mono';">${entry.callsign}</td>
                <td style="font-family:'JetBrains Mono'; font-weight:700;">${entry.dep}</td>
                <td style="font-family:'JetBrains Mono'; font-weight:700;">${entry.arr}</td>
                <td style="color:var(--accent-green); font-weight:700;">${entry.time}</td>
                <td style="font-weight:700;">${entry.acft}</td>
                <td>
                    <div style="display:flex; gap:5px; justify-content:center;">
                        <button class="btn-logbook" style="background:rgba(245, 158, 11, 0.1); color:var(--accent-orange); border-color:var(--accent-orange);" title="Estacionar aeronave no Hangar" onclick="parkFromLogbook('${entry.callsign}', '${entry.acft}', '${entry.arr}')">üÖøÔ∏è HANGAR</button>
                        <button class="btn-remove" title="Apagar Registro" aria-label="Apagar registro do logbook" onclick="deleteLogbookEntry(${entry.id})">üóëÔ∏è</button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function deleteLogbookEntry(id) {
        if(!confirm("Excluir registro?")) return;
        let logbook = getSafeStorage('myPilotLogbook');
        logbook = logbook.filter(entry => entry.id !== id);
        localStorage.setItem('myPilotLogbook', JSON.stringify(logbook));
        renderLogbook();
    }

    function toggleLogbook() {
        const div = document.getElementById('logbook-section');
        if (div.style.display === 'none') {
            div.style.display = 'block';
            renderLogbook();
            div.scrollIntoView({ behavior: 'smooth' });
        } else {
            div.style.display = 'none';
        }
    }

    function clearLogbook() {
        if(confirm("Apagar todo o hist√≥rico?")) {
            localStorage.removeItem('myPilotLogbook');
            renderLogbook();
        }
    }

    function backupLogbook() {
        const dataStr = JSON.stringify({
            version: "7.0",
            date: new Date().toISOString(),
            simbrief_id: localStorage.getItem('simbrief_id') || "",
            logbook: getSafeStorage('myPilotLogbook'),
            roster: getSafeStorage('myPilotRoster'),
            hangar: getSafeStorage('myPilotHangar')
        }, null, 2);
        
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_rpl_v7_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function restoreLogbook(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (data.logbook) {
                    if(confirm("Restaurar backup?")) {
                        localStorage.setItem('myPilotLogbook', JSON.stringify(data.logbook));
                        if (data.roster) localStorage.setItem('myPilotRoster', JSON.stringify(data.roster));
                        if (data.hangar) localStorage.setItem('myPilotHangar', JSON.stringify(data.hangar));
                        if (data.simbrief_id) {
                            localStorage.setItem('simbrief_id', data.simbrief_id);
                            document.getElementById('sb-id').value = data.simbrief_id;
                        }
                        renderLogbook();
                        renderRoster();
                        renderHangar();
                        alert("Restaurado com sucesso!");
                    }
                }
            } catch (err) { alert("Erro ao ler o arquivo de backup."); }
            event.target.value = '';
        };
        reader.readAsText(file);
    }

    /* --- FUN√á√ÉO AUXILIAR NOVA: PREENCHE O MODAL --- */
    function openModalWithFlight(f) {
        document.getElementById('modal-cia-badge').innerText = f.airline.name;
        document.getElementById('modal-cia-badge').style.backgroundColor = f.airline.color;
        document.getElementById('modal-flight-num').innerText = f.ident;
        document.getElementById('md-acft').innerText = f.type;
        document.getElementById('md-route').textContent = f.rota; 
        document.getElementById('md-deparr').innerText = `${f.origin} -> ${f.dest}`;
        document.getElementById('md-eet').innerText = minutesToTimeStr(f.durMin).replace(':', 'h ') + 'm';
        document.getElementById('md-fl').innerText = f.fl;
        document.getElementById('md-days').innerText = formatDaysLocal(f.daysOp, f.depMinUTC);
        document.getElementById('md-obs').textContent = f.obs;
        document.getElementById('flight-modal').style.display = 'flex';
    }

    function showFlightDetails(index) {
        const f = displayedFlights[index];
        if (f) openModalWithFlight(f);
    }

    function showRosterFlightDetails(id) {
        const roster = getSafeStorage('myPilotRoster');
        const entry = roster.find(e => e.id === id);
        if (entry) openModalWithFlight(entry.flightData);
    }

    function closeModal() { document.getElementById('flight-modal').style.display = 'none'; }
    window.onclick = function(event) {
        if (event.target == document.getElementById('flight-modal')) closeModal();
    }

    function getSimulationDate() {
        if (USE_REAL_TIME_DATE) return new Date();
        const realNow = new Date();
        const [y, m, d] = SIMULATE_DATE_FIXED.split('-').map(Number);
        return new Date(y, m - 1, d, realNow.getHours(), realNow.getMinutes(), realNow.getSeconds());
    }

    function updateClock() {
        const now = getSimulationDate(); 
        const timeOptions = { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' };
        const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('brt-clock').innerText = now.toLocaleTimeString('pt-BR', timeOptions);
        document.getElementById('brt-date').innerText = now.toLocaleDateString('pt-BR', dateOptions).toUpperCase();
    }
    setInterval(updateClock, 1000);
    updateClock();

    async function loadAllFiles() {
        allFlightsDB = [];
        const allButtons = document.querySelectorAll('button');
        allButtons.forEach(btn => btn.disabled = true);
        document.getElementById('empty-msg').innerText = "Sincronizando banco de dados RPL... Aguarde.";

        try {
            const promises = airlineConfig.map(async (airline) => {
                try {
                    const response = await fetch(airline.file);
                    if (!response.ok) throw new Error("404");
                    const text = await response.text();
                    checkValidityDate(text);
                    const flights = parseRPLData(text, airline);
                    return { status: "OK", flights: flights };
                } catch (error) { return { status: "Erro", flights: [] }; }
            });
            const results = await Promise.all(promises);
            results.forEach(res => { if(res.flights.length > 0) allFlightsDB = allFlightsDB.concat(res.flights); });
            if (allFlightsDB.length > 0) document.getElementById('empty-msg').innerText = "Sistema pronto. Insira uma Origem ou selecione um Filtro acima.";
            else document.getElementById('empty-msg').innerText = "Erro: Arquivos RPL n√£o encontrados no servidor.";
        } finally { allButtons.forEach(btn => btn.disabled = false); }
    }

    function checkValidityDate(text) {
        if (validityUpdated) return; 
        const regex = /IN[I√ç]CIO DE VALIDADE:\s*(\d{2})([a-z]{3})\.(\d{4})/i;
        const match = text.match(regex);
        if (match) {
            const day = parseInt(match[1]);
            const monthStr = match[2].toLowerCase();
            const year = parseInt(match[3]);
            const months = { 'jan':0, 'fev':1, 'mar':2, 'abr':3, 'mai':4, 'jun':5, 'jul':6, 'ago':7, 'set':8, 'out':9, 'nov':10, 'dez':11 };
            
            if (months[monthStr] !== undefined) {
                const startDate = new Date(year, months[monthStr], day);
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6); 
                const opts = { day: '2-digit', month: 'short', year: 'numeric' };
                const startFmt = startDate.toLocaleDateString('pt-BR', opts).toUpperCase().replace('.', '');
                const endFmt = endDate.toLocaleDateString('pt-BR', opts).toUpperCase().replace('.', '');
                const cleanStart = startFmt.replace(' DE ', ' ');
                const cleanEnd = endFmt.replace(' DE ', ' ');
                document.getElementById("validity-box").innerText = `CYCLE: ${cleanStart} - ${cleanEnd}`;
                validityUpdated = true;
            }
        }
    }

    function parseRPLData(textData, airlineInfo) {
        const lines = textData.split('\n');
        const flights = [];
        for (let line of lines) {
            line = line.trim();
            if (line.length < 50 || !/^\d{6}\s+\d{6}/.test(line)) continue;
            const parts = line.split(/\s+/);
            const speedIndex = parts.findIndex(p => /^[NM]\d{3,4}$/.test(p));
            if (speedIndex !== -1 && parts.length > speedIndex + 3) {
                try {
                    const daysOp = parts[2]; const ident = parts[3]; const type = parts[4];
                    const adepEobt = parts[speedIndex - 1]; 
                    const origin = adepEobt.substring(0, 4); const depTimeUTC = adepEobt.substring(4, 8); 
                    const fl = parts[speedIndex + 1];
                    let destIndex = parts.findIndex((p, idx) => idx > speedIndex && /^[A-Z]{4}\d{4}$/.test(p));
                    if (destIndex !== -1) {
                        const destEet = parts[destIndex];
                        const dest = destEet.substring(0, 4); const eetStr = destEet.substring(4, 8); 
                        const rota = parts.slice(speedIndex + 2, destIndex).join(' ');
                        const obs = parts.slice(destIndex + 1).join(' ');
                        const depMinUTC = timeStrToMinutes(depTimeUTC); const durMin = timeStrToMinutes(eetStr);
                        flights.push({
                            airline: airlineInfo, ident, type, origin, dest, depMinUTC,
                            arrMinUTC: depMinUTC + durMin, durMin, fl, rota, obs, daysOp
                        });
                    }
                } catch(e) {}
            }
        }
        return flights;
    }
</script>
</body>
</html>