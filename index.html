<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RPL Dispatch 6.5 - Escala & Fixes</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
    /* --- VARI√ÅVEIS E RESET --- */
    :root {
        --bg-body: #f3f5f9;
        --bg-card: #ffffff;
        --text-main: #2d3748;
        --text-muted: #718096;
        --primary: #4e73df;
        --accent-purple: #6f42c1;
        --accent-cyan: #36b9cc;
        --accent-green: #1cc88a;
        --accent-red: #e74a3b;
        --accent-orange: #f6c23e;
        --shadow-sm: 0 2px 4px rgba(0,0,0,0.02);
        --shadow-md: 0 4px 6px rgba(0,0,0,0.04), 0 1px 3px rgba(0,0,0,0.08);
        --radius: 12px;
    }

    * { box-sizing: border-box; outline: none; }

    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--bg-body);
        color: var(--text-main);
        padding: 20px;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        font-size: 14px;
    }

    /* --- LAYOUT WRAPPER --- */
    .dashboard-wrapper {
        width: 100%;
        max-width: 1400px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    /* --- ESTILO DE CARDS --- */
    .card-panel {
        background-color: var(--bg-card);
        border-radius: var(--radius);
        box-shadow: var(--shadow-md);
        padding: 25px;
        width: 100%;
        border: 1px solid rgba(0,0,0,0.03);
    }

    /* --- CABE√áALHO --- */
    .header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--bg-card);
        border-radius: var(--radius);
        padding: 20px 30px;
        box-shadow: var(--shadow-md);
    }

    .header-title h1 {
        margin: 0;
        font-size: 24px;
        font-weight: 800;
        color: var(--primary);
        letter-spacing: -0.5px;
    }
    .header-title div {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        margin-top: 4px;
    }

    .center-info { text-align: center; }
    .center-main-text {
        font-weight: 700;
        font-size: 16px;
        color: var(--text-main);
        text-transform: uppercase;
    }
    .center-sub-text {
        font-family: 'JetBrains Mono', monospace;
        font-size: 12px;
        color: var(--text-muted);
        background: #f1f3f9;
        padding: 4px 10px;
        border-radius: 6px;
        margin-top: 5px;
        display: inline-block;
    }

    .clock-box { text-align: right; }
    .clock-time {
        font-family: 'JetBrains Mono', monospace;
        font-size: 28px;
        font-weight: 700;
        color: var(--text-main);
        letter-spacing: -1px;
    }
    .clock-date { font-size: 12px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }

    /* --- CONTROLES --- */
    .controls-grid {
        display: grid;
        /* Aumentado minmax para 200px para dar mais espa√ßo */
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        align-items: end;
    }

    .control-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%; /* Garante que o grupo ocupe a c√©lula do grid */
    }

    .control-label {
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        color: var(--text-muted);
        letter-spacing: 0.5px;
    }

    .sb-input {
        background: #f8f9fc;
        border: 1px solid #e3e6f0;
        border-radius: 8px;
        padding: 10px 15px;
        font-family: 'Inter', sans-serif;
        font-weight: 600;
        color: var(--text-main);
        width: 100%;
        transition: all 0.2s;
    }
    .sb-input:focus {
        border-color: var(--primary);
        background: #fff;
        box-shadow: 0 0 0 3px rgba(78, 115, 223, 0.1);
    }

    /* Bot√µes Modernos */
    button {
        cursor: pointer;
        border: none;
        padding: 10px 16px;
        border-radius: 8px;
        font-family: 'Inter', sans-serif;
        font-weight: 700;
        font-size: 12px;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        text-transform: uppercase;
    }
    button:active { transform: translateY(1px); }

    .btn-action { background: var(--primary); color: white; }
    .btn-action:hover { background: #3b5cb8; box-shadow: 0 4px 12px rgba(78, 115, 223, 0.3); }

    .btn-search { background: var(--accent-purple); color: white; height: 38px; }
    .btn-search:hover { background: #5a32a3; box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3); }

    .btn-reset { background: #e2e6ea; color: var(--text-muted); }
    .btn-reset:hover { background: #dbe0e5; color: var(--text-main); }

    .btn-logbook { 
        background: #fff; 
        color: var(--text-main); 
        border: 1px solid #e3e6f0;
        font-size: 11px;
        padding: 6px 12px;
        margin-top: 5px;
    }
    .btn-logbook:hover { border-color: var(--primary); color: var(--primary); }

    /* Filtros CIA */
    .filter-wrapper { display: flex; gap: 5px; background: #f8f9fc; padding: 4px; border-radius: 8px; }
    .btn-filter {
        flex: 1;
        background: transparent;
        color: var(--text-muted);
        padding: 8px;
        font-size: 11px;
        border-radius: 6px;
    }
    .btn-filter:hover { background: rgba(0,0,0,0.03); }
    .btn-filter.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    
    .btn-filter[data-cia="LATAM"].active { color: #1B0088; font-weight: 800; }
    .btn-filter[data-cia="GOL"].active { color: #FF5E00; font-weight: 800; }
    .btn-filter[data-cia="AZUL"].active { color: #0055A4; font-weight: 800; }

    /* Pernas */
    .legs-wrapper { display: flex; gap: 5px; }
    .btn-draw { flex: 1; background: var(--text-main); color: white; }
    .btn-draw:hover { background: var(--primary); }

    /* Bot√µes Tabela */
    .btn-sb { background: var(--accent-red); color: white; padding: 6px 10px; font-size: 11px; border-radius: 6px; }
    .btn-sb:hover { background: #c0392b; box-shadow: 0 2px 8px rgba(231, 74, 59, 0.3); }

    .btn-schedule { background: var(--accent-cyan); color: white; padding: 6px 10px; font-size: 14px; border-radius: 6px; }
    .btn-schedule:hover { background: #2c9faf; }

    .btn-remove { background: #e74a3b; color: white; padding: 6px 10px; border-radius: 6px; font-size: 11px; }

    /* --- TABELAS --- */
    .flight-table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1000px; }
    
    .flight-table th {
        background: #f8f9fc;
        color: var(--text-muted);
        font-weight: 700;
        text-transform: uppercase;
        font-size: 11px;
        padding: 15px 20px;
        text-align: left;
        border-bottom: 1px solid #e3e6f0;
        letter-spacing: 0.5px;
    }
    .flight-table th:first-child { border-top-left-radius: var(--radius); }
    .flight-table th:last-child { border-top-right-radius: var(--radius); }

    .flight-table td {
        padding: 15px 20px;
        border-bottom: 1px solid #f1f3f9;
        color: var(--text-main);
        vertical-align: middle;
        font-size: 13px;
        background: white;
        transition: background 0.2s;
    }
    .flight-table tr:last-child td { border-bottom: none; }
    .flight-table tr:hover td { background: #fafbfc; }

    /* Colunas Espec√≠ficas */
    .col-flight { font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--primary); font-size: 14px; cursor: pointer; }
    .col-flight:hover { text-decoration: underline; }

    .cia-badge { 
        padding: 4px 8px; border-radius: 6px; color: white; 
        font-weight: 700; font-size: 10px; text-transform: uppercase; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .col-airport { font-weight: 700; font-size: 14px; color: var(--text-main); }

    /* Time Pills */
    .time-pill {
        display: inline-flex; flex-direction: column; align-items: center; justify-content: center;
        background: var(--text-main); color: white;
        padding: 5px 12px; border-radius: 8px; min-width: 70px;
    }
    .time-pill.arr { background: var(--text-muted); }
    .tp-utc { font-size: 10px; opacity: 0.7; font-family: 'JetBrains Mono'; margin-bottom: 2px; }
    .tp-local { font-size: 15px; font-weight: 700; font-family: 'JetBrains Mono'; line-height: 1; }

    .col-fl { font-family: 'JetBrains Mono'; font-weight: 700; color: var(--text-main); background: #f1f3f9; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
    .col-rota { font-family: 'JetBrains Mono'; font-size: 11px; color: var(--text-muted); max-width: 250px; line-height: 1.4; }

    /* --- ROSTER --- */
    .roster-header { 
        display: flex; justify-content: space-between; align-items: center; 
        margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f1f3f9; 
    }
    .section-title { font-size: 18px; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
    .section-badge { background: var(--accent-cyan); color: white; padding: 2px 8px; border-radius: 20px; font-size: 11px; font-weight: 700; }

    /* --- WIDGETS --- */
    .stats-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px;
    }
    .stat-card {
        background: #fff; border: 1px solid #f1f3f9; border-radius: 12px; padding: 20px;
        display: flex; align-items: center; gap: 15px;
    }
    .stat-icon { 
        width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-size: 20px;
    }
    .icon-blue { background: rgba(78, 115, 223, 0.1); color: var(--primary); }
    .icon-green { background: rgba(28, 200, 138, 0.1); color: var(--accent-green); }
    
    .stat-info h4 { margin: 0; font-size: 12px; color: var(--text-muted); text-transform: uppercase; font-weight: 700; }
    .stat-info p { margin: 5px 0 0 0; font-size: 22px; font-weight: 800; color: var(--text-main); font-family: 'JetBrains Mono'; }

    /* --- TUTORIAL --- */
    .tutorial-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
    .tut-card { 
        background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #f1f3f9;
        transition: transform 0.2s;
    }
    .tut-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
    .tut-card h4 { margin: 0 0 10px 0; color: var(--primary); font-size: 14px; font-weight: 700; }
    .tut-card p { margin: 0; font-size: 12px; color: var(--text-muted); line-height: 1.5; }

    /* --- MODAL GERAL --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); z-index: 2000;
        display: none; justify-content: center; align-items: center;
        backdrop-filter: blur(5px);
    }
    .modal-content {
        background: white; padding: 30px; border-radius: 16px;
        width: 90%; max-width: 600px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        animation: slideUp 0.3s ease-out;
    }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f1f3f9; }
    .modal-title { font-size: 20px; font-weight: 800; color: var(--text-main); }
    .close-modal { font-size: 24px; color: var(--text-muted); background: none; padding: 0; }
    
    .detail-row { display: flex; padding: 12px 0; border-bottom: 1px dashed #e3e6f0; }
    .detail-label { width: 140px; font-weight: 600; color: var(--text-muted); font-size: 12px; text-transform: uppercase; }
    .detail-val { flex: 1; font-family: 'JetBrains Mono'; font-weight: 700; color: var(--text-main); }

    /* Responsive */
    @media (max-width: 900px) {
        .header-container { flex-direction: column; gap: 15px; text-align: center; }
        .header-right { align-items: center; }
        .controls-grid { grid-template-columns: 1fr; }
        .clock-time { font-size: 24px; }
        .flight-table-container { overflow-x: auto; }
    }
</style>
</head>
<body>

<div class="dashboard-wrapper">

    <div class="header-container">
        <div class="header-title">
            <h1>RPL Dispatch 6.5</h1>
            <div>Simulador de Voo Dom√©stico</div>
        </div>
        
        <div class="center-info">
            <div class="center-main-text">MALHA A√âREA REAL BRASIL</div>
            <div class="center-sub-text" id="validity-box">VALIDADE: ---</div>
        </div>

        <div class="clock-box">
            <div class="clock-time" id="brt-clock">00:00:00</div>
            <div class="clock-date" id="brt-date">---</div>
            <button class="btn-logbook" onclick="toggleLogbook()">üìñ ABRIR LOGBOOK</button>
        </div>
    </div>

    <div class="card-panel">
        <div class="controls-grid">
            
            <div class="control-group">
                <label class="control-label">SimBrief ID</label>
                <input type="text" id="sb-id" class="sb-input" placeholder="Ex: 123456" oninput="saveSBID()">
            </div>

            <div class="control-group">
                <label class="control-label">Companhia A√©rea</label>
                <div class="filter-wrapper">
                    <button class="btn-filter active" onclick="setFilter('todas', this)">Todas</button>
                    <button class="btn-filter" data-cia="LATAM" onclick="setFilter('LATAM', this)">Latam</button>
                    <button class="btn-filter" data-cia="GOL" onclick="setFilter('GOL', this)">Gol</button>
                    <button class="btn-filter" data-cia="AZUL" onclick="setFilter('AZUL', this)">Azul</button>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">Gerar Escala</label>
                <div class="legs-wrapper">
                    <button class="btn-draw" onclick="generateRealTimeChain(1)">1</button>
                    <button class="btn-draw" onclick="generateRealTimeChain(2)">2</button>
                    <button class="btn-draw" onclick="generateRealTimeChain(3)">3</button>
                    <button class="btn-draw" onclick="generateRealTimeChain(4)">4</button>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">Buscar Voo</label>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="search-input" class="sb-input" placeholder="N¬∫ Voo" onkeydown="if(event.key==='Enter') manualSearch()">
                    <button class="btn-search" onclick="manualSearch()">BUSCAR</button>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">Rota</label>
                <div style="display:flex; align-items:center; gap:8px;">
                    <input type="text" id="airport-search" class="sb-input" placeholder="Origem" onkeydown="if(event.key==='Enter') searchByAirport()">
                    <span style="color:#cbd5e0;">&rarr;</span>
                    <input type="text" id="destination-search" class="sb-input" placeholder="Destino" onkeydown="if(event.key==='Enter') searchByAirport()">
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">Agende sua escala de voo</label>
                <div style="display:flex; gap:5px;">
                    <input type="date" id="filter-date" class="sb-input" style="flex: 1; min-width: 0;" title="Deixe vazio para HOJE">
                    <input type="time" id="filter-time" class="sb-input" style="flex: 1; min-width: 0;" title="Deixe vazio para AGORA">
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">&nbsp;</label>
                <button class="btn-reset" onclick="resetPanel()">Limpar Filtros</button>
            </div>

        </div>
    </div>

    <div class="card-panel" style="padding:0; overflow:hidden;">
        <div style="padding: 20px 25px; border-bottom:1px solid #f1f3f9;">
            <div style="font-weight:700; color:var(--text-main); font-size:16px;">Quadro de Voos Dispon√≠veis</div>
        </div>
        <div style="overflow-x:auto;">
            <table class="flight-table">
                <thead>
                    <tr>
                        <th style="text-align: center;">A√ß√µes</th> 
                        <th>Voo</th>
                        <th>Cia</th>
                        <th>Aeronave</th>
                        <th>Origem</th>
                        <th>Hor√°rios (Z / BRT)</th>
                        <th>Destino</th>
                        <th>Chegada (Z / BRT)</th>
                        <th style="text-align: center;">FL</th>
                        <th>Rota</th>
                        <th>Obs</th>
                    </tr>
                </thead>
                <tbody id="board-content"></tbody>
            </table>
            <div id="empty-msg" style="padding:50px; text-align:center; color:var(--text-muted); font-style:italic;">
                Carregando dados da malha...
            </div>
        </div>
    </div>

    <div id="roster-section" class="card-panel" style="padding:0; overflow:hidden;">
        <div class="roster-header" style="margin:0; padding: 20px 25px; border-bottom:1px solid #f1f3f9;">
            <div class="section-title">üìÖ Minha Escala (Roster) <span class="section-badge" id="roster-badge">0</span></div>
            <div style="font-size: 12px; color:var(--text-muted);">Seus voos agendados</div>
        </div>
        
        <div style="overflow-x:auto;">
            <table class="flight-table">
                <thead>
                    <tr>
                        <th style="text-align: center;">Gerenciar</th> 
                        <th>Data/Hora (Z)</th>
                        <th>Voo</th>
                        <th>Cia</th>
                        <th>Aeronave</th>
                        <th>Origem</th>
                        <th>Destino</th>
                        <th>FL</th>
                        <th>Rota</th>
                    </tr>
                </thead>
                <tbody id="roster-body">
                </tbody>
            </table>
            <div id="roster-empty" style="padding:40px; text-align:center; color:var(--text-muted); display:block;">
                Nenhum voo na escala. Clique no √≠cone <span style="background:var(--accent-cyan); color:white; padding:2px 6px; border-radius:4px;">üìÖ</span> para adicionar.
            </div>
        </div>
    </div>

    <div id="logbook-section" class="card-panel" style="display: none;">
        <div class="roster-header">
            <div class="section-title">üìñ Logbook do Piloto</div>
            <div style="display: flex; gap: 8px;">
                <input type="file" id="backup-file-input" style="display: none;" onchange="restoreLogbook(event)">
                <button class="btn-reset" onclick="backupLogbook()">‚¨áÔ∏è Backup</button>
                <button class="btn-reset" onclick="document.getElementById('backup-file-input').click()">‚¨ÜÔ∏è Restaurar</button>
                <button class="btn-remove" onclick="clearLogbook()">Limpar Tudo</button>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon icon-blue">‚úàÔ∏è</div>
                <div class="stat-info">
                    <h4>Total de Voos</h4>
                    <p id="stats-count">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon icon-green">‚è±Ô∏è</div>
                <div class="stat-info">
                    <h4>Horas Voadas</h4>
                    <p id="stats-hours">00h 00m</p>
                </div>
            </div>
        </div>

        <div style="overflow-x:auto; border-radius:8px; border:1px solid #f1f3f9;">
            <table class="flight-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Voo</th>
                        <th>Origem</th>
                        <th>Destino</th>
                        <th>Tempo</th>
                        <th>Aeronave</th>
                        <th style="text-align:center;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="logbook-body"></tbody>
            </table>
            <div id="logbook-empty" style="padding:30px; text-align:center; color:var(--text-muted); display:none;">
                Nenhum registro ainda.
            </div>
        </div>
    </div>

    <div class="tutorial-grid">
        <div class="tut-card">
            <h4>üìÖ Agendamento Inteligente</h4>
            <p>Clique no √≠cone üìÖ para escolher a <strong>Data e Hora exata</strong> do seu voo. O SimBrief respeitar√° esse agendamento.</p>
        </div>
        <div class="tut-card">
            <h4>üéØ Filtros de Tempo (Novo)</h4>
            <p>Use os campos "Quando?" para buscar voos em datas e hor√°rios espec√≠ficos. Se deixar vazio, o sistema usa o rel√≥gio atual.</p>
        </div>
        <div class="tut-card">
            <h4>üìÑ SimBrief Direto</h4>
            <p>O bot√£o vermelho j√° envia a aeronave, rota, matr√≠cula e <strong>hor√°rio ZULU correto</strong> para o SimBrief.</p>
        </div>
    </div>

</div> <div id="flight-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">
                <span id="modal-cia-badge" class="cia-badge" style="font-size:14px;">CIA</span>
                <span id="modal-flight-num" style="margin-left:10px;">VOO 1234</span>
            </div>
            <button class="close-modal" onclick="closeModal('flight-modal')">√ó</button>
        </div>
        <div id="modal-body">
            <div class="detail-row"><span class="detail-label">Aeronave</span> <span class="detail-val" id="md-acft"></span></div>
             <div class="detail-row"><span class="detail-label">Rota Completa</span> <span class="detail-val" id="md-route" style="font-size:11px;"></span></div>
             <div class="detail-row"><span class="detail-label">Trecho</span> <span class="detail-val" id="md-deparr"></span></div>
             <div class="detail-row"><span class="detail-label">Tempo Estimado</span> <span class="detail-val" id="md-eet"></span></div>
             <div class="detail-row"><span class="detail-label">N√≠vel (FL)</span> <span class="detail-val" id="md-fl"></span></div>
             <div class="detail-row"><span class="detail-label">Dias de Opera√ß√£o</span> <span class="detail-val" id="md-days"></span></div>
             <div class="detail-row"><span class="detail-label">Observa√ß√µes</span> <span class="detail-val" id="md-obs"></span></div>
        </div>
    </div>
</div>

<div id="schedule-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <div class="modal-title">Agendar Voo</div>
            <button class="close-modal" onclick="closeModal('schedule-modal')">√ó</button>
        </div>
        <div style="display:flex; flex-direction:column; gap:20px;">
            <div style="background:#f8f9fc; padding:15px; border-radius:8px; text-align:center;">
                <div id="sch-flight-num" style="font-weight:800; font-size:18px; color:var(--primary);">VOO</div>
                <div id="sch-route" style="font-size:12px; color:var(--text-muted); margin-top:5px;">DEP - ARR</div>
            </div>
            
            <div class="control-group">
                <label class="control-label">Data do Voo</label>
                <input type="date" id="sch-date" class="sb-input">
            </div>
            
            <div class="control-group">
                <label class="control-label">Hor√°rio de Sa√≠da (ZULU)</label>
                <input type="time" id="sch-time" class="sb-input">
            </div>

            <button class="btn-action" style="width:100%; height:45px; margin-top:10px;" onclick="confirmSchedule()">CONFIRMAR AGENDAMENTO</button>
        </div>
    </div>
</div>

<div id="file-debug" style="display:none;"></div>

<script>
    const USE_REAL_TIME_DATE = true; 
    const SIMULATE_DATE_FIXED = "2026-02-07"; 
    const TURNAROUND_MINUTES = 45; 

    const airlineConfig = [
        { id: 'LATAM', name: 'LATAM', file: 'Cia_TAM_CS.txt', color: '#1B0088' },
        { id: 'GOL', name: 'GOL', file: 'Cia_GLO_CS.txt', color: '#FF5E00' },
        { id: 'AZUL', name: 'AZUL', file: 'Cia_AZU_CS.txt', color: '#0055A4' }
    ];

    let allFlightsDB = [];
    let currentFilter = 'todas';
    let displayedFlights = [];
    let validityUpdated = false;
    let selectedFlightForSchedule = null;

    function getSafeStorage(key) {
        try {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        } catch (e) { return []; }
    }

    document.addEventListener("DOMContentLoaded", () => {
        const savedID = localStorage.getItem("simbrief_id");
        if (savedID) document.getElementById("sb-id").value = savedID;
        renderLogbook();
        renderRoster();
    });

    function saveSBID() {
        localStorage.setItem("simbrief_id", document.getElementById("sb-id").value);
    }

    // --- HELPER DE TEMPO DE REFER√äNCIA ---
    function getReferenceTime() {
        const dateInput = document.getElementById('filter-date').value;
        const timeInput = document.getElementById('filter-time').value;
        
        let now;
        
        if (dateInput) {
            // Se usu√°rio definiu data
            if (timeInput) {
                // Se definiu data e hora, usa a combina√ß√£o
                now = new Date(`${dateInput}T${timeInput}`);
            } else {
                // Se s√≥ definiu data, assume meia-noite (00:00) ou hora atual desse dia
                // Vamos usar a hora atual do dia selecionado para manter consist√™ncia
                const tempNow = new Date();
                const h = String(tempNow.getHours()).padStart(2, '0');
                const m = String(tempNow.getMinutes()).padStart(2, '0');
                now = new Date(`${dateInput}T${h}:${m}`);
            }
        } else {
            // Se n√£o definiu data, usa l√≥gica padr√£o (Hoje Real)
            now = getSimulationDate();
        }
        
        // Calcula minutos UTC
        const utcMinutes = (now.getUTCHours() * 60) + now.getUTCMinutes();
        
        return { dateObj: now, utcMinutes: utcMinutes };
    }

    function openSimBriefWithData(flight, customDateObj = null, customHours = null, customMinutes = null) {
        const sbID = document.getElementById("sb-id").value;
        if (!sbID) {
            alert("Preencha o ID do SimBrief no painel de controles.");
            document.getElementById("sb-id").focus();
            return;
        }

        saveToLogbook(flight);

        const airlineCode = flight.ident.match(/^[A-Z]+/)[0];
        const fltNumber = flight.ident.match(/\d+/)[0];
        let cleanType = flight.type.split('/')[0]; 
        const routeEncoded = encodeURIComponent(flight.rota);

        let hours, minutes;
        if (customHours !== null && customMinutes !== null) {
            hours = parseInt(customHours);
            minutes = parseInt(customMinutes);
        } else {
            hours = Math.floor(flight.depMinUTC / 60);
            minutes = flight.depMinUTC % 60;
            if (hours >= 24) hours = hours % 24;
        }

        const dateObj = customDateObj || new Date();
        const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
        const day = String(dateObj.getUTCDate()).padStart(2, '0');
        const month = monthNames[dateObj.getUTCMonth()];
        const year = String(dateObj.getUTCFullYear()).slice(-2); 
        const sbDate = `${day}${month}${year}`;

        const url = `https://www.simbrief.com/system/dispatch.php?userid=${sbID}&airline=${airlineCode}&fltnum=${fltNumber}&orig=${flight.origin}&dest=${flight.dest}&route=${routeEncoded}&type=${cleanType}&date=${sbDate}&deph=${hours}&depm=${minutes}`;
        
        window.open(url, '_blank');
    }

    function openSimBriefFromIndex(index) {
        const flight = displayedFlights[index];
        if (!flight) return;
        // Se houver data de filtro selecionada, usa ela para o SimBrief
        const ref = getReferenceTime();
        // Se o usu√°rio filtrou por data, assume que quer voar nessa data
        if(document.getElementById('filter-date').value) {
             // Hora ZULU do voo
             let h = Math.floor(flight.depMinUTC / 60);
             let m = flight.depMinUTC % 60;
             openSimBriefWithData(flight, ref.dateObj, h, m);
        } else {
             openSimBriefWithData(flight);
        }
    }

    function scheduleFlight(index) {
        selectedFlightForSchedule = displayedFlights[index];
        if (!selectedFlightForSchedule) return;

        document.getElementById('sch-flight-num').innerText = selectedFlightForSchedule.ident;
        document.getElementById('sch-route').innerText = `${selectedFlightForSchedule.origin} -> ${selectedFlightForSchedule.dest}`;

        // Se houver filtro de data, usa ele como padr√£o no modal
        const filterDate = document.getElementById('filter-date').value;
        if(filterDate) {
            document.getElementById('sch-date').value = filterDate;
        } else {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            document.getElementById('sch-date').value = `${yyyy}-${mm}-${dd}`;
        }

        let h = Math.floor(selectedFlightForSchedule.depMinUTC / 60);
        let m = selectedFlightForSchedule.depMinUTC % 60;
        if(h >= 24) h = h % 24;
        const timeStr = String(h).padStart(2,'0') + ":" + String(m).padStart(2,'0');
        document.getElementById('sch-time').value = timeStr;

        document.getElementById('schedule-modal').style.display = 'flex';
    }

    function confirmSchedule() {
        if (!selectedFlightForSchedule) return;

        const dateVal = document.getElementById('sch-date').value;
        const timeVal = document.getElementById('sch-time').value;

        if (!dateVal || !timeVal) {
            alert("Por favor, selecione data e hora.");
            return;
        }

        let roster = getSafeStorage('myPilotRoster');
        
        const entry = {
            id: Date.now(),
            flightData: selectedFlightForSchedule,
            scheduledDate: dateVal, 
            scheduledTime: timeVal  
        };

        roster.push(entry);
        
        roster.sort((a, b) => {
            const dtA = new Date(a.scheduledDate + 'T' + a.scheduledTime);
            const dtB = new Date(b.scheduledDate + 'T' + b.scheduledTime);
            return dtA - dtB;
        });
        
        localStorage.setItem('myPilotRoster', JSON.stringify(roster));
        renderRoster();
        closeModal('schedule-modal');
        document.getElementById('roster-section').scrollIntoView({behavior: 'smooth'});
    }

    function renderRoster() {
        const roster = getSafeStorage('myPilotRoster');
        const tbody = document.getElementById('roster-body');
        const emptyMsg = document.getElementById('roster-empty');
        
        document.getElementById('roster-badge').innerText = roster.length;

        tbody.innerHTML = '';
        if (roster.length === 0) { emptyMsg.style.display = 'block'; return; }
        else { emptyMsg.style.display = 'none'; }

        roster.forEach(entry => {
            const f = entry.flightData;
            const tr = document.createElement('tr');
            
            const sbButton = `<button class="btn-sb" onclick="dispatchRosterFlight(${entry.id})">SIMBRIEF ‚Üó</button>`;
            const removeButton = `<button class="btn-remove" title="Remover" onclick="deleteRosterEntry(${entry.id})">‚úï</button>`;

            const dateParts = entry.scheduledDate.split('-'); 
            const dateDisplay = `${dateParts[2]}/${dateParts[1]}`; 
            const timeDisplay = entry.scheduledTime + 'z';

            const acftType = f.type.split('/')[0];

            tr.innerHTML = `
                <td style="text-align:center; white-space:nowrap; display:flex; gap:5px; justify-content:center;">${sbButton}${removeButton}</td>
                <td style="font-weight:700; color:var(--text-main); font-family:'JetBrains Mono';">${dateDisplay} ${timeDisplay}</td>
                <td class="col-flight">${f.ident}</td>
                <td><span class="cia-badge" style="background-color: ${f.airline.color}">${f.airline.name}</span></td>
                <td style="font-weight:700;">${acftType}</td>
                <td class="col-airport">${f.origin}</td>
                <td class="col-airport">${f.dest}</td>
                <td class="col-fl">${f.fl}</td>
                <td class="col-rota">${f.rota}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function dispatchRosterFlight(id) {
        const roster = getSafeStorage('myPilotRoster');
        const entry = roster.find(e => e.id === id);
        if (entry) {
            const dateParts = entry.scheduledDate.split('-'); 
            const scheduledDateObj = new Date(Date.UTC(dateParts[0], dateParts[1]-1, dateParts[2]));
            const timeParts = entry.scheduledTime.split(':');
            openSimBriefWithData(entry.flightData, scheduledDateObj, timeParts[0], timeParts[1]);
        }
    }

    function resetPanel() {
        document.getElementById('board-content').innerHTML = '';
        document.getElementById('empty-msg').style.display = 'block';
        document.getElementById('empty-msg').innerText = "Painel limpo. Selecione os filtros acima.";
        document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
        document.getElementById('filter-date').value = '';
        document.getElementById('filter-time').value = '';
        displayedFlights = [];
    }

    function manualSearch() {
        const rawInput = document.getElementById('search-input').value;
        const input = rawInput ? rawInput.toUpperCase().replace(/\s+/g, '') : "";
        if (input.length < 3) { alert("Digite pelo menos 3 caracteres."); return; }
        if(allFlightsDB.length === 0) { alert("Aguarde o carregamento."); return; }
        const matches = allFlightsDB.filter(f => f.ident.includes(input));
        if (matches.length === 0) { alert("Voo n√£o encontrado."); return; }
        matches.sort((a,b) => a.depMinUTC - b.depMinUTC);
        const enriched = matches.map(f => enrichFlightData(f));
        displayedFlights = enriched;
        renderRows(enriched);
        document.getElementById('empty-msg').style.display = 'none';
    }

    function searchByAirport() {
        const rawOrig = document.getElementById('airport-search').value;
        const orig = rawOrig ? rawOrig.toUpperCase().trim() : "";
        const rawDest = document.getElementById('destination-search').value;
        const dest = rawDest ? rawDest.toUpperCase().trim() : "";
        
        if (orig.length < 3) { alert("Digite o c√≥digo de origem (Ex: SBSP)."); return; }
        if(allFlightsDB.length === 0) { alert("Aguarde o carregamento."); return; }

        // USA A REFER√äNCIA DE TEMPO (Pode ser Agora ou Futuro)
        const ref = getReferenceTime();
        
        // Se o usu√°rio preencheu o campo de HORA, ele quer ver voos a partir daquele hor√°rio.
        // Se n√£o preencheu hora (s√≥ data), mostramos voos do dia inteiro (>= 0 minutes).
        const filterMinutes = document.getElementById('filter-time').value ? ref.utcMinutes : 0;

        const matches = allFlightsDB.filter(f => {
            const airlineMatch = (currentFilter === 'todas') || (f.airline.name === currentFilter);
            const routeMatch = (f.origin === orig) && (dest ? f.dest === dest : true);
            
            // Valida o dia da semana baseado na DATA escolhida (ref.dateObj)
            const validDay = isFlightValidToday(f, ref.dateObj);
            
            // Valida o hor√°rio (Maior que o hor√°rio escolhido)
            const validTime = f.depMinUTC >= filterMinutes;

            return routeMatch && validDay && validTime && airlineMatch; 
        });

        if (matches.length === 0) {
            alert("Nenhum voo encontrado para esta data/rota.");
            return;
        }

        matches.sort((a,b) => a.depMinUTC - b.depMinUTC);
        const enriched = matches.map(f => enrichFlightData(f));
        displayedFlights = enriched;
        renderRows(enriched);
        document.getElementById('empty-msg').style.display = 'none';
    }

    function deleteRosterEntry(id) {
        if(!confirm("Remover da escala?")) return;
        let roster = getSafeStorage('myPilotRoster');
        roster = roster.filter(e => e.id !== id);
        localStorage.setItem('myPilotRoster', JSON.stringify(roster));
        renderRoster();
    }

    function backupLogbook() {
        const dataStr = JSON.stringify({
            version: "6.5",
            date: new Date().toISOString(),
            simbrief_id: localStorage.getItem('simbrief_id') || "",
            logbook: getSafeStorage('myPilotLogbook'),
            roster: getSafeStorage('myPilotRoster')
        }, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_rpl_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function restoreLogbook(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (data.logbook) {
                    if(confirm("Restaurar backup?")) {
                        localStorage.setItem('myPilotLogbook', JSON.stringify(data.logbook));
                        if (data.roster) localStorage.setItem('myPilotRoster', JSON.stringify(data.roster));
                        if (data.simbrief_id) {
                            localStorage.setItem('simbrief_id', data.simbrief_id);
                            document.getElementById('sb-id').value = data.simbrief_id;
                        }
                        renderLogbook();
                        renderRoster();
                        alert("Restaurado!");
                    }
                }
            } catch (err) { alert("Erro no arquivo."); }
            event.target.value = '';
        };
        reader.readAsText(file);
    }

    function showFlightDetails(index) {
        const f = displayedFlights[index];
        if (!f) return;
        document.getElementById('modal-cia-badge').innerText = f.airline.name;
        document.getElementById('modal-cia-badge').style.backgroundColor = f.airline.color;
        document.getElementById('modal-flight-num').innerText = f.ident;
        document.getElementById('md-acft').innerText = f.type;
        document.getElementById('md-route').textContent = f.rota; 
        document.getElementById('md-deparr').innerText = `${f.origin} -> ${f.dest}`;
        document.getElementById('md-eet').innerText = minutesToTimeStr(f.durMin).replace(':', 'h ') + 'm';
        document.getElementById('md-fl').innerText = f.fl;
        document.getElementById('md-days').innerText = formatDaysOp(f.daysOp);
        document.getElementById('md-obs').textContent = f.obs;
        document.getElementById('flight-modal').style.display = 'flex';
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    window.onclick = function(event) {
        if (event.target.classList.contains('modal-overlay')) {
            event.target.style.display = 'none';
        }
    }

    function formatDaysOp(daysStr) {
        if (!daysStr) return "N/A";
        const labels = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'];
        let active = [];
        for (let i = 0; i < daysStr.length; i++) {
            if (daysStr[i] !== ' ' && daysStr[i] !== '0') active.push(labels[i]);
        }
        return active.length > 0 ? active.join(', ') : "N√£o especificado";
    }

    function getSimulationDate() {
        if (USE_REAL_TIME_DATE) return new Date();
        const realNow = new Date();
        const [y, m, d] = SIMULATE_DATE_FIXED.split('-').map(Number);
        return new Date(y, m - 1, d, realNow.getHours(), realNow.getMinutes(), realNow.getSeconds());
    }

    function updateClock() {
        const now = getSimulationDate(); 
        const timeOptions = { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' };
        const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('brt-clock').innerText = now.toLocaleTimeString('pt-BR', timeOptions);
        document.getElementById('brt-date').innerText = now.toLocaleDateString('pt-BR', dateOptions).toUpperCase();
    }
    setInterval(updateClock, 1000);
    updateClock();

    async function loadAllFiles() {
        allFlightsDB = [];
        const allButtons = document.querySelectorAll('button');
        allButtons.forEach(btn => btn.disabled = true);
        document.getElementById('empty-msg').innerText = "Carregando malha a√©rea... Por favor aguarde.";

        try {
            const promises = airlineConfig.map(async (airline) => {
                try {
                    const response = await fetch(airline.file);
                    if (!response.ok) throw new Error("404");
                    const text = await response.text();
                    checkValidityDate(text);
                    const flights = parseRPLData(text, airline);
                    return { status: "OK", flights: flights };
                } catch (error) { return { status: "Erro", flights: [] }; }
            });
            const results = await Promise.all(promises);
            results.forEach(res => { if(res.flights.length > 0) allFlightsDB = allFlightsDB.concat(res.flights); });
            if (allFlightsDB.length > 0) document.getElementById('empty-msg').innerText = "Sistema pronto. Utilize os filtros acima.";
            else document.getElementById('empty-msg').innerText = "Erro: Arquivos .txt n√£o encontrados.";
        } finally { allButtons.forEach(btn => btn.disabled = false); }
    }

    function checkValidityDate(text) {
        if (validityUpdated) return; 
        const regex = /IN[I√ç]CIO DE VALIDADE:\s*(\d{2})([a-z]{3})\.(\d{4})/i;
        const match = text.match(regex);
        if (match) {
            const day = parseInt(match[1]);
            const monthStr = match[2].toLowerCase();
            const year = parseInt(match[3]);
            const months = { 'jan':0, 'fev':1, 'mar':2, 'abr':3, 'mai':4, 'jun':5, 'jul':6, 'ago':7, 'set':8, 'out':9, 'nov':10, 'dez':11 };
            if (months[monthStr] !== undefined) {
                const startDate = new Date(year, months[monthStr], day);
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6); 
                const opts = { day: '2-digit', month: 'short', year: 'numeric' };
                const startFmt = startDate.toLocaleDateString('pt-BR', opts).toUpperCase().replace('.', '');
                const endFmt = endDate.toLocaleDateString('pt-BR', opts).toUpperCase().replace('.', '');
                const cleanStart = startFmt.replace(' DE ', ' ');
                const cleanEnd = endFmt.replace(' DE ', ' ');
                document.getElementById("validity-box").innerText = `VALIDADE: ${cleanStart} A ${cleanEnd}`;
                validityUpdated = true;
            }
        }
    }

    function parseRPLData(textData, airlineInfo) {
        const lines = textData.split('\n');
        const flights = [];
        for (let line of lines) {
            line = line.trim();
            if (line.length < 50 || !/^\d{6}\s+\d{6}/.test(line)) continue;
            const parts = line.split(/\s+/);
            const speedIndex = parts.findIndex(p => /^[NM]\d{3,4}$/.test(p));
            if (speedIndex !== -1 && parts.length > speedIndex + 3) {
                try {
                    const daysOp = parts[2]; const ident = parts[3]; const type = parts[4];
                    const adepEobt = parts[speedIndex - 1]; 
                    const origin = adepEobt.substring(0, 4); const depTimeUTC = adepEobt.substring(4, 8); 
                    const fl = parts[speedIndex + 1];
                    let destIndex = parts.findIndex((p, idx) => idx > speedIndex && /^[A-Z]{4}\d{4}$/.test(p));
                    if (destIndex !== -1) {
                        const destEet = parts[destIndex];
                        const dest = destEet.substring(0, 4); const eetStr = destEet.substring(4, 8); 
                        const rota = parts.slice(speedIndex + 2, destIndex).join(' ');
                        const obs = parts.slice(destIndex + 1).join(' ');
                        const depMinUTC = timeStrToMinutes(depTimeUTC); const durMin = timeStrToMinutes(eetStr);
                        flights.push({
                            airline: airlineInfo, ident, type, origin, dest, depMinUTC,
                            arrMinUTC: depMinUTC + durMin, durMin, fl, rota, obs, daysOp
                        });
                    }
                } catch(e) {}
            }
        }
        return flights;
    }

    function generateRealTimeChain(chainLength) {
        const ref = getReferenceTime(); 
        const currentUTCMinutes = ref.utcMinutes;
        
        let validFlightsToday = allFlightsDB.filter(f => isFlightValidToday(f, ref.dateObj));
        if (currentFilter !== 'todas') validFlightsToday = validFlightsToday.filter(f => f.airline.name === currentFilter);
        
        const orig = document.getElementById('airport-search').value.toUpperCase().trim();
        let candidates = [];

        if (orig.length >= 3) {
            candidates = validFlightsToday.filter(f => f.origin === orig);
            let future = candidates.filter(f => f.depMinUTC >= currentUTCMinutes + 30);
            if (future.length > 0) candidates = future;
            else candidates = [];
        } else {
            candidates = validFlightsToday.filter(f => f.depMinUTC >= currentUTCMinutes + 30);
            if (candidates.length === 0) candidates = validFlightsToday.filter(f => f.depMinUTC >= currentUTCMinutes);
        }

        if (candidates.length === 0) { alert("Sem voos dispon√≠veis para este hor√°rio/data."); return; }
        
        candidates.sort((a,b) => a.depMinUTC - b.depMinUTC);
        const seed = candidates[Math.floor(Math.random() * Math.min(15, candidates.length))];
        let chain = [enrichFlightData(seed)];

        for (let i = 1; i < chainLength; i++) {
            const prev = chain[i-1];
            const prevArr = prev.arrMinUTC >= 1440 ? prev.arrMinUTC - 1440 : prev.arrMinUTC;
            const minNext = prevArr + TURNAROUND_MINUTES;
            let nextLegs = validFlightsToday.filter(f => f.airline.name === prev.airline.name && f.origin === prev.dest && f.depMinUTC >= minNext);
            
            if (nextLegs.length === 0) nextLegs = validFlightsToday.filter(f => f.airline.name === prev.airline.name && f.origin === prev.dest);
            if (nextLegs.length > 0) {
                nextLegs.sort((a,b) => {
                    let dA = a.depMinUTC - minNext; if(dA<0) dA+=1440;
                    let dB = b.depMinUTC - minNext; if(dB<0) dB+=1440;
                    return dA - dB;
                });
                chain.push(enrichFlightData(nextLegs[0]));
            } else break;
        }
        
        displayedFlights = chain;
        renderRows(chain);
        document.getElementById('empty-msg').style.display = 'none';
    }

    function enrichFlightData(flight) {
        const toBRT = (utc) => { let b = utc - 180; if(b<0) b+=1440; if(b>=1440) b-=1440; return b; };
        const depMinBRT = toBRT(flight.depMinUTC);
        const arrMinBRT = toBRT(flight.arrMinUTC);
        let arrUtc = flight.arrMinUTC >= 1440 ? flight.arrMinUTC - 1440 : flight.arrMinUTC;
        let nextDay = arrMinBRT < depMinBRT;
        
        return {
            ...flight,
            depDisplay: minutesToTimeStr(depMinBRT),
            arrDisplay: minutesToTimeStr(arrMinBRT),
            depDisplayUTC: minutesToTimeStr(flight.depMinUTC),
            arrDisplayUTC: minutesToTimeStr(arrUtc),
            isNextDay: nextDay
        };
    }

    function isFlightValidToday(flight, dateObj) {
        const d = dateObj.getDay(); 
        const idx = d === 0 ? 6 : d - 1; 
        const char = flight.daysOp.charAt(idx);
        return char !== '0' && char !== ' ';
    }

    function timeStrToMinutes(str) {
        return (parseInt(str.substring(0,2))*60) + parseInt(str.substring(2,4));
    }

    function minutesToTimeStr(min) {
        let h = Math.floor(min/60)%24; let m = Math.floor(min%60);
        return String(h).padStart(2,'0') + ":" + String(m).padStart(2,'0');
    }

    function renderRows(flights) {
        const tbody = document.getElementById('board-content');
        tbody.innerHTML = '';
        flights.forEach((f, index) => {
            const tr = document.createElement('tr');
            
            const sbButton = `<button class="btn-sb" onclick="openSimBriefFromIndex(${index})">SIMBRIEF</button>`;
            const scheduleButton = `<button class="btn-schedule" title="Agendar" onclick="scheduleFlight(${index})">üìÖ</button>`;
            const arrHtml = f.isNextDay ? `<span style="color:var(--accent-orange)">(+1)</span>` : ``;
            const depCell = `<div class="time-pill"><div class="tp-utc">${f.depDisplayUTC}z</div><div class="tp-local">${f.depDisplay}</div></div>`;
            const arrCell = `<div class="time-pill arr"><div class="tp-utc">${f.arrDisplayUTC}z</div><div class="tp-local">${f.arrDisplay} ${arrHtml}</div></div>`;
            const acftType = f.type.split('/')[0];

            tr.innerHTML = `
                <td style="text-align:center; display:flex; gap:5px; justify-content:center;">${sbButton}${scheduleButton}</td>
                <td class="col-flight" onclick="showFlightDetails(${index})">${f.ident}</td>
                <td><span class="cia-badge" style="background-color: ${f.airline.color}">${f.airline.name}</span></td>
                <td style="font-weight:bold;">${acftType}</td>
                <td class="col-airport">${f.origin}</td>
                <td style="text-align:center;">${depCell}</td>
                <td class="col-airport">${f.dest}</td>
                <td style="text-align:center;">${arrCell}</td>
                <td class="col-fl">${f.fl}</td>
                <td class="col-rota">${f.rota}</td>
                <td class="col-obs">${f.obs}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function setFilter(cia, btn) {
        currentFilter = cia;
        document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('board-content').innerHTML = '';
        document.getElementById('empty-msg').style.display = 'block';
    }

    loadAllFiles();
</script>
</body>
</html>